<!-- <!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd"> -->

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
 	<meta name="description" content="ç¼–ç¨‹">
 	<meta name="keywords" content="ITæ•™ç¨‹ ">
    <meta name="viewport" content="width=device-width, initial-scale=1 , user-scalable=no">
    
<!-- <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/> -->
<title>é”-iOSå¼€å‘(é«˜çº§ç¯‡)</title>


    

	<link rel="stylesheet" href="/lib/css/bootstrap.min.css">
    <link rel="stylesheet" href="/lib/css/bootstrap-maizi.css">
    <link rel="stylesheet" href="/lib/css/animate.css">
    <!-- <script  src="https://libs.baidu.com/jquery/1.10.2/jquery.min.js"></script> -->
    <script src="/lib/js/jquery.min.js"></script>
    <script src="/lib/js/bootstrap.min.js"></script>
    
    <script src="/lib/js/jquery.singlePageNav.min.js"></script>
    <script src="/lib/js/jquery.cookie.js"></script>
    
	
<script src="/js/article.js"></script>
<!--ç™¾åº¦ç»Ÿè®¡-->
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?a684a10bc59d54f03381c502765556bb";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


<script type="text/javascript">
    // var siteHome = './';
    var staticHTMLUri = '/';
</script>


</head>
<body>
	
		  
		   <div style="height:50px;margin-bottom: 0px;"><nav class="navbar navbar-default navbar-fixed-top" id="topNav">		   <div class="container"> 
		    <!--å¯¼èˆª--> 
		    <!--å°å±å¹•å¯¼èˆªæŒ‰é’®å’Œlogo--> 
		    <div class="navbar-header"> 
		     <button class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> 
		     <a href="https://guitom.github.io/" class="navbar-brand" style="color: #1196EE;"><span>è¶£é€šå°æ•™ç¨‹</span>&nbsp;<span>guitom.github.io</span></a> 
		    </div> 
		    <!--å°å±å¹•å¯¼èˆªæŒ‰é’®å’Œlogo--> 
		    <div class="navbar-collapse collapse"> 
		     <div class="profile navbar-right"> 
			      <!-- 	<ul class="nav navbar-nav"> 
			       		<li><a href="#home" data-toggle="modal" id="collector">æ”¶è—å¤¹</a></li>
			       		<li><a href="#home" data-toggle="modal" id="homePageloginBtn">ç™»å½•</a></li> 
			      		<li><a href="#home" data-toggle="modal" id="loginStatus"></a></li> 
			      	</ul>  -->
		      		
		     </div> 
		     <ul class="nav navbar-nav navbar-center"> 
		      <li> 
		       <!--æœç´¢æ¡†--> 
		       <div class="input-group hidden" id="searchBox" style="max-width:300px;height:30px;margin-top:10px;"> 
		        <input type="text" class="form-control input-md" placeholder="è¾“å…¥å…³é”®è¯" onkeydown="onKeyDown(event)" /> 
		        <span class="input-group-addon btn btn-primary">æœç´¢</span> 
		       </div> 
		       <!--æœç´¢æ¡†--></li> 
	
		     </ul> 
		    </div> 
		   </div> </nav></div>
		  
	
	
<style type="text/css">
    .panel-heading{
        padding-top: 5px;
        padding-right: 5px;
    }
    .panel-body {
        padding: 10px;
    }
    .panel-body div {
        padding-left: 20px;
    }

    .menu-container{
        border-width: 2px;
        border-radius: 5px;
        border-color: green;
        border:5px solid #f6f4f0;
    
    }
    .menu-container div{
        padding-right: 10px;
        padding-left: 10px;
        line-height: 30px;
    }
    .chapter{
        background-color: #f0f0f0;
        font-weight: bold;

    }
    .course{
        background-color: #e2e2e2;
        text-indent: 0em;
    }
    .normal{
        color: black;
    }
    .selected{
        background-color: #1196EE;
        color: white;
    }
    .block{
        /*border: thick solid #e1e1e1;*/
        
    }
    .preview{
        display: none;
    }
    .item{
        border-bottom-style:solid;
        border-width: 1px;
        border-color: #f1f1f1;
        cursor:pointer;
    }
    .content{
        border-radius: 5px;
    }
    a:hover{
        text-decoration: none;
    }
    body{
        background-color: #dfdfdf;
    }
    td {
        border: 1px solid #ddd
    }
</style>
<div class="container">
<!-- <div class="row">
    <div class="col-sm-12" style="background-color: white;border-radius:8px;border-style: solid;border-color:#dfdfdf ">
        
    </div>
</div> -->
<div class="row">
    <div class="col-sm-12 text-center" style="padding-top: 20px;">
        <strong>é”-iOSå¼€å‘(é«˜çº§ç¯‡)</strong>
    </div>
</div>
<div class="row" style="margin-top:5px;">
    <div class="col-sm-2" style="overflow-y: auto;max-height:100%;overflow-x: hidden;">
                <div class="menu-container">
                    <div id="06024caB" class="item chapter normal selected">Runtime</div>

<div id="5b514C5a" class="item course normal">æ–¹æ³•äº¤æ¢</div>
<div id="67C92673" class="item course normal">åŠ¨æ€æ·»åŠ æ–¹æ³•</div>
<div id="8A546ac3" class="item course normal">å…³è”å¯¹è±¡</div><div id="39c93aA5" class="item course normal">KVOçš„å®ç°</div><div id="93C8046a" class="item chapter normal">å†…å­˜ç®¡ç†</div><div id="c1944c7C" class="item course normal">TaggedPointer</div><div id="3ABca2ab" class="item course normal">å°æµ‹éªŒ</div><div id="AAB71A4b" class="item course normal">NONPOINTER_ISA</div><div id="3Ac50559" class="item course normal">æ•£åˆ—è¡¨ </div><div id="8BA7CC22" class="item course normal">Copyå’ŒmutableCopy</div><div id="6B5C7c25" class="item course normal">å¯¹è±¡çš„é”€æ¯dealloc</div><div id="97cc9C51" class="item course normal">å¸¸ç”¨lldbå‘½ä»¤</div>


































<div id="9ccab66A" class="item chapter normal">RunLoop</div><div id="3C6a652B" class="item course normal">NSTimeråº”ç”¨</div><div id="07A53392" class="item course normal">çº¿ç¨‹ä¿æ´»</div><div id="4a6ac2bb" class="item course normal">UIImageç©ºé—²æ—¶æ¸²æŸ“</div><div id="A5bCb944" class="item course normal">çº¿ç¨‹é—´é€šä¿¡(NSPort)</div><div id="471ab021" class="item course normal">å¡é¡¿æ£€æµ‹</div><div id="30A6AA7A" class="item course normal">è‡ªåŠ¨é‡Šæ”¾æ± </div><div id="2A662A6A" class="item chapter normal">UIè§†å›¾</div><div id="4b1Aa8ba" class="item course normal">UIç»˜åˆ¶åŸç†</div><div id="C1AB418B" class="item course normal">UIäº‹ä»¶ä¼ é€’æœºåˆ¶</div><div id="3C991812" class="item course normal">äº‹ä»¶ä¼ é€’ç›¸å…³ç»ƒä¹ é¢˜</div><div id="12B75430" class="item course normal">äº‹ä»¶å“åº”é“¾</div><div id="4Cc0CC83" class="item course normal">ç›¸å…³é¢è¯•é¢˜</div><div id="0CbB19c9" class="item chapter normal">å¤šçº¿ç¨‹</div><div id="217b960B" class="item course normal">pthread</div><div id="53870C1a" class="item course normal">NSThread</div><div id="3a61B9a4" class="item course normal">GCDåŸºç¡€API(1)</div><div id="88bB0879" class="item course normal">GCDåŸºç¡€API(2)</div><div id="cc300B3b" class="item course normal">GCDç»å…¸é¢è¯•é¢˜</div><div id="29108B1C" class="item course normal">GCDé«˜çº§ API</div><div id="8BC7b1B3" class="item course normal">NSOpreation</div><div id="4635Bb8A" class="item course normal">å¤šçº¿ç¨‹é¢è¯•é¢˜</div><div id="C5C1C965" class="item course normal">é”</div><div id="28c98C11" class="item course normal">é”ç›¸å…³é¢è¯•é¢˜</div><div id="B529829C" class="item course normal">ä¿¡å·é‡</div><div id="8a900c58" class="item chapter normal">OCè¯­è¨€</div><div id="A01181B1" class="item course normal">å±æ€§å…³é”®å­—</div><div id="a24C78b3" class="item course normal">å†…å­˜ç®¡ç†</div><div id="1472b4c0" class="item course normal">KVO</div><div id="BC924416" class="item chapter normal">blockåŠå…¶æœ¬è´¨</div><div id="61a4a56A" class="item course normal">blockæŒ‰å­˜å‚¨åŒºåˆ†ç±»</div><div id="C3803054" class="item course normal">å˜é‡æˆªå–</div><div id="Cc14A93c" class="item course normal">ç›¸å…³é¢è¯•é¢˜</div><div id="a6a97753" class="item chapter normal">ç¬¬ä¸‰æ–¹åº“</div><div id="14ab67AB" class="item course normal">AFNetWorking</div><div id="6A235a3B" class="item course normal">SDWebImageView</div><div id="2c7C0120" class="item course normal">ReactiveCocoa</div><div id="a5488b6B" class="item course normal">AsyncDisplayKit</div><div id="B5b3B053" class="item chapter normal">æ€§èƒ½ä¼˜åŒ–</div><div id="0A415471" class="item course normal">UIå¡é¡¿ä¼˜åŒ–</div><div id="C094BcBc" class="item course normal">ç¦»å±æ¸²æŸ“ä¼˜åŒ–</div><div id="b2b21885" class="item course normal">å¡é¡¿æ£€æµ‹</div><div id="56529C54" class="item course normal">ç”µé‡ä¼˜åŒ–</div><div id="AcaAbB32" class="item course normal">APPå†·å¯åŠ¨ä¼˜åŒ–</div>
                </div>
                <div style="float:left;margin-top: 30px;width: 1px;height: 100%;background: darkgray;"></div>
        </div>
    <div class="col-sm-10 content" style="overflow-y: auto;height: 100%;background-color: white;padding-top:20px;">
         <div class="row">
             <div class="col-sm-12">
                 <p>åœ¨å¹³æ—¶å¼€å‘ä¸­æˆ‘ä»¬ç»å¸¸ä¼šä½¿ç”¨å¤šçº¿ç¨‹ï¼Œå¤šçº¿ç¨‹ä¸ºæˆ‘ä»¬å¸¦æ¥äº†å¾ˆå¤§ä¾¿åˆ©ï¼Œä¹Ÿæé«˜äº†ç¨‹åºçš„æ‰§è¡Œæ•ˆç‡ï¼Œä½†åŒæ—¶ä¹Ÿå¸¦æ¥äº†<code>Data race</code>ï¼Œ<code>Data race</code>çš„å®šä¹‰å¾ˆç®€å•ï¼šå½“è‡³å°‘æœ‰ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®åŒä¸€ä¸ªå˜é‡ï¼Œè€Œä¸”è‡³å°‘å…¶ä¸­æœ‰ä¸€ä¸ªæ˜¯å†™æ“ä½œæ—¶ï¼Œå°±å‘ç”Ÿäº†<code>Data race</code>ã€‚æ‰€ä»¥è¿™æ˜¯å°±è¦åˆ©ç”¨ä¸€äº›åŒæ­¥æœºåˆ¶æ¥ç¡®ä¿æ•°æ®çš„å‡†ç¡®æ€§ï¼Œé”å°±æ˜¯åŒæ­¥æœºåˆ¶ä¸­çš„ä¸€ç§ã€‚</p><p><br/></p><h2>æ€ä¹ˆæ£€æµ‹é¡¹ç›®ä¸­çš„<code>Data race</code>ï¼Ÿ</h2><p><br/></p><p style="text-align:center"><img data-original-src="//upload-images.jianshu.io/upload_images/1457495-7da10e7cbd400978.png" data-original-width="2160" data-original-height="1122" data-original-format="" data-original-filesize="216121" class="" data-image-index="1" src="/upload/image/2019113/162221952515.png" width="620" height="295" style="text-align: center; white-space: normal; cursor: zoom-in; width: 620px; height: 295px;"/></p><p><br/>åªéœ€è¦åœ¨è®¾ç½®ä¸­å‹¾é€‰<code>Thread Sanitizer</code> å³å¯ï¼Œé¡ºä¾¿å¯ä»¥å‹¾é€‰<code>Pause on issues</code> å°±å¯ä»¥æ–­ç‚¹åˆ°ç›¸åº”çš„ä»£ç ã€‚<br/>æ›´å¤šå»¶ä¼¸å†…å®¹è¯·å‚è€ƒPeakå›çš„<a href="http://mrpeak.cn/blog/thread-sanitizer/" target="_blank" rel="nofollow">å¦‚ä½•ç”¨Xcode8è§£å†³å¤šçº¿ç¨‹é—®é¢˜</a>å’Œ<a href="http://www.mrpeak.cn/blog/ios-thread-safety/" target="_blank" rel="nofollow">iOSå¤šçº¿ç¨‹åˆ°åº•ä¸å®‰å…¨åœ¨å“ªé‡Œï¼Ÿ</a></p><p><br/></p><p>ä¸‹é¢å°±è¿›å…¥æ­£é¢˜ç®€å•èŠä¸€èŠiOSä¸­çš„é”ï¼Œä»¥åŠç›¸å…³çš„å†…å®¹ï¼ˆç”±äºæœ¬äººèƒ½åŠ›æœ‰é™ï¼Œæ–‡ä¸­éš¾å…æœ‰ä¸€äº›é—æ¼æˆ–è€…é”™è¯¯ï¼Œè¯·å„ä½çœ‹å®˜ä¸åèµæ•™ï¼è°¢è°¢ï¼ğŸ™)</p><h2>ç®€å•çš„æ€§èƒ½æµ‹è¯•</h2><p>ä¸‹å›¾æ˜¯æˆ‘é’ˆå¯¹iOSä¸­çš„é”è‡ªå·±æµ‹è¯•å¾—å‡ºçš„ï¼Œå›¾ä¸­æ•°å­—ä»£è¡¨æ¯æ¬¡åŠ è§£é”éœ€è¦æ¶ˆè€—çš„æ—¶é—´ï¼Œå•ä½ä¸ºnsã€‚<a href="https://github.com/maligh/ML-Objective-C-Demo/tree/master/LockPerformance" target="_blank" rel="nofollow">ä»£ç åœ¨è¿™é‡Œ</a>ï¼Œä»£ç å‚è€ƒè‡ªYYå¤§ç¥çš„<a href="https://blog.ibireme.com/2016/01/16/spinlock_is_unsafe_in_ios/" target="_blank" rel="nofollow">ä¸å†å®‰å…¨çš„ OSSpinLock</a>ï¼ŒåŸºæœ¬è·ŸYYå¤§ç¥çš„å›¾å·®ä¸å¤šğŸ˜‰ï¼ŒYYå¤§ç¥çš„å•ä½æ˜¯Î¼sï¼Œåº”è¯¥æ˜¯1000æ¬¡çš„ï¼Œæˆ–è€…å†™é”™äº†å§~<br/></p><p><img src="/upload/image/202068/163135502613.png" width="746" height="356" style="width: 746px; height: 356px;"/></p><p>LockPerformance.jpg</p><p><br/></p><ul class=" list-paddingleft-2"><li><p>æ³¨ï¼šè¿è¡Œæ‰‹æœºï¼š iphone6s plus ï¼Œç³»ç»Ÿç‰ˆæœ¬ï¼š11.2.2ï¼ŒXcode9.2ï¼›æ•°å­—çš„å•ä½ä¸ºnsï¼ˆå¾—å‡ºçš„å…·ä½“æ•°å€¼æ˜¯è·‘äº†å¤šæ¬¡å–çš„å‡å€¼ï¼‰ã€‚</p></li></ul><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼š1.è¿™ä¸ªæ•°å­—ä»…ä»…ä»£è¡¨æ¯æ¬¡åŠ è§£é”çš„è€—æ—¶ï¼Œå¹¶ä¸èƒ½å…¨æ–¹é¢çš„ä»£è¡¨æ€§èƒ½ã€‚2.ä¸åŒçš„æœºå‹å’Œç³»ç»Ÿï¼Œä¸åŒçš„å¾ªç¯æ¬¡æ•°å¯èƒ½ç»“æœä¼šç•¥å¾®æœ‰äº›å·®å¼‚ã€‚<br/>ä½†æ˜¯è¿˜æ˜¯å¯ä»¥çœ‹å‡º<code>@synchronized:</code>æ˜¯è¡¨ç°æœ€å·®çš„ã€‚</p><p><strong>åœ¨å…·ä½“è¯´è¿™äº›é”ä¹‹å‰ï¼Œå…ˆæ¥è¯´å‡ ä¸ªæ¦‚å¿µå®šä¹‰ï¼š</strong>(å‚è€ƒ<a href="https://www.wikipedia.org/" target="_blank" rel="nofollow">ç»´åŸºç™¾ç§‘</a>)</p><ol class=" list-paddingleft-2"><li><p><strong>ä¸´ç•ŒåŒºï¼š</strong>æŒ‡çš„æ˜¯ä¸€å—å¯¹å…¬å…±èµ„æºè¿›è¡Œè®¿é—®çš„ä»£ç ï¼Œå¹¶éä¸€ç§æœºåˆ¶æˆ–æ˜¯ç®—æ³•ã€‚</p></li><li><p><strong>è‡ªæ—‹é”ï¼š</strong>æ˜¯ç”¨äºå¤šçº¿ç¨‹åŒæ­¥çš„ä¸€ç§é”ï¼Œçº¿ç¨‹åå¤æ£€æŸ¥é”å˜é‡æ˜¯å¦å¯ç”¨ã€‚ç”±äºçº¿ç¨‹åœ¨è¿™ä¸€è¿‡ç¨‹ä¸­ä¿æŒæ‰§è¡Œï¼Œå› æ­¤æ˜¯ä¸€ç§<code>å¿™ç­‰å¾…</code>ã€‚ä¸€æ—¦è·å–äº†è‡ªæ—‹é”ï¼Œçº¿ç¨‹ä¼šä¸€ç›´ä¿æŒè¯¥é”ï¼Œç›´è‡³æ˜¾å¼é‡Šæ”¾è‡ªæ—‹é”ã€‚ è‡ªæ—‹é”é¿å…äº†è¿›ç¨‹ä¸Šä¸‹æ–‡çš„è°ƒåº¦å¼€é”€ï¼Œå› æ­¤å¯¹äºçº¿ç¨‹åªä¼šé˜»å¡å¾ˆçŸ­æ—¶é—´çš„åœºåˆæ˜¯æœ‰æ•ˆçš„ã€‚</p></li><li><p><strong>äº’æ–¥é”ï¼ˆMutexï¼‰ï¼š</strong>æ˜¯ä¸€ç§ç”¨äºå¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ï¼Œé˜²æ­¢ä¸¤æ¡çº¿ç¨‹åŒæ—¶å¯¹åŒä¸€å…¬å…±èµ„æºï¼ˆæ¯”å¦‚å…¨å±€å˜é‡ï¼‰è¿›è¡Œè¯»å†™çš„æœºåˆ¶ã€‚è¯¥ç›®çš„é€šè¿‡å°†ä»£ç åˆ‡ç‰‡æˆä¸€ä¸ªä¸€ä¸ªçš„ä¸´ç•ŒåŒºè€Œè¾¾æˆã€‚</p></li><li><p><strong>è¯»å†™é”ï¼š</strong>æ˜¯è®¡ç®—æœºç¨‹åºçš„å¹¶å‘æ§åˆ¶çš„ä¸€ç§åŒæ­¥æœºåˆ¶ï¼Œä¹Ÿç§°â€œå…±äº«-äº’æ–¥é”â€ã€å¤šè¯»è€…-å•å†™è€…é”) ç”¨äºè§£å†³å¤šçº¿ç¨‹å¯¹å…¬å…±èµ„æºè¯»å†™é—®é¢˜ã€‚è¯»æ“ä½œå¯å¹¶å‘é‡å…¥ï¼Œå†™æ“ä½œæ˜¯äº’æ–¥çš„ã€‚ è¯»å†™é”é€šå¸¸ç”¨äº’æ–¥é”ã€æ¡ä»¶å˜é‡ã€ä¿¡å·é‡å®ç°ã€‚</p></li><li><p><strong>ä¿¡å·é‡ï¼ˆsemaphoreï¼‰ï¼š</strong>æ˜¯ä¸€ç§æ›´é«˜çº§çš„åŒæ­¥æœºåˆ¶ï¼Œ<code>äº’æ–¥é”</code>å¯ä»¥è¯´æ˜¯semaphoreåœ¨ä»…å–å€¼0/1æ—¶çš„ç‰¹ä¾‹ã€‚<code>ä¿¡å·é‡</code>å¯ä»¥æœ‰æ›´å¤šçš„å–å€¼ç©ºé—´ï¼Œç”¨æ¥å®ç°æ›´åŠ å¤æ‚çš„åŒæ­¥ï¼Œè€Œä¸å•å•æ˜¯çº¿ç¨‹é—´äº’æ–¥ã€‚</p></li><li><p><strong>æ¡ä»¶é”ï¼š</strong>å°±æ˜¯æ¡ä»¶å˜é‡ï¼Œå½“è¿›ç¨‹çš„æŸäº›èµ„æºè¦æ±‚ä¸æ»¡è¶³æ—¶å°±è¿›å…¥ä¼‘çœ ï¼Œä¹Ÿå°±æ˜¯é”ä½äº†ã€‚å½“èµ„æºè¢«åˆ†é…åˆ°äº†ï¼Œæ¡ä»¶é”æ‰“å¼€ï¼Œè¿›ç¨‹ç»§ç»­è¿è¡Œã€‚</p></li></ol><h2>äº’æ–¥é”</h2><p><strong>1.NSLockï¼š</strong>æ˜¯Foundationæ¡†æ¶ä¸­ä»¥å¯¹è±¡å½¢å¼æš´éœ²ç»™å¼€å‘è€…çš„ä¸€ç§é”ï¼Œï¼ˆFoundationæ¡†æ¶åŒæ—¶æä¾›äº†<code>NSConditionLock</code>ï¼Œ<code>NSRecursiveLock</code>ï¼Œ<code>NSCondition</code>ï¼‰<code>NSLock</code>å®šä¹‰å¦‚ä¸‹ï¼š</p><pre class="line-numbers  language-objectivec">@protocol&nbsp;NSLocking-&nbsp;(void)lock;
-&nbsp;(void)unlock;
@end
@interface&nbsp;NSLock&nbsp;:&nbsp;NSObject&nbsp;&lt;NSLocking&gt;
&nbsp;{@private
&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;*_priv;}
-&nbsp;(BOOL)tryLock;
-&nbsp;(BOOL)lockBeforeDate:(NSDate&nbsp;*)limit;
@property&nbsp;(nullable,&nbsp;copy)&nbsp;NSString&nbsp;*name&nbsp;
@end</pre><p>tryLock å’Œ lock æ–¹æ³•éƒ½ä¼šè¯·æ±‚åŠ é”ï¼Œå”¯ä¸€ä¸åŒçš„æ˜¯trylockåœ¨æ²¡æœ‰è·å¾—é”çš„æ—¶å€™å¯ä»¥ç»§ç»­åšä¸€äº›ä»»åŠ¡å’Œå¤„ç†ã€‚lockBeforeDateæ–¹æ³•ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯åœ¨limitæ—¶é—´ç‚¹ä¹‹å‰è·å¾—é”ï¼Œæ²¡æœ‰æ‹¿åˆ°è¿”å›NOã€‚<br/><strong>å®é™…é¡¹ç›®ä¸­ï¼š</strong>NSLockåœ¨<a href="https://github.com/AFNetworking/AFNetworking/blob/master/AFNetworking/AFURLSessionManager.m" target="_blank" rel="nofollow">AFNetworkingçš„AFURLSessionManager.m</a>ä¸­åº”ç”¨å¦‚ä¸‹ï¼š</p><pre class="line-numbers  language-objectivec">-&nbsp;(instancetype)initWithSessionConfiguration:(NSURLSessionConfiguration&nbsp;*)configuration&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;...
&nbsp;&nbsp;&nbsp;&nbsp;self.lock&nbsp;=&nbsp;[[NSLock&nbsp;alloc]&nbsp;init];
&nbsp;&nbsp;&nbsp;&nbsp;self.lock.name&nbsp;=&nbsp;AFURLSessionManagerLockName;
&nbsp;&nbsp;&nbsp;&nbsp;...
}
-&nbsp;(void)setDelegate:(AFURLSessionManagerTaskDelegate&nbsp;*)delegate
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;forTask:(NSURLSessionTask&nbsp;*)task{
&nbsp;&nbsp;&nbsp;&nbsp;...
&nbsp;&nbsp;&nbsp;&nbsp;[self.lock&nbsp;lock];
&nbsp;&nbsp;&nbsp;&nbsp;self.mutableTaskDelegatesKeyedByTaskIdentifier[@(task.taskIdentifier)]&nbsp;=&nbsp;delegate;
&nbsp;&nbsp;&nbsp;&nbsp;[delegate&nbsp;setupProgressForTask:task];
&nbsp;&nbsp;&nbsp;&nbsp;[self&nbsp;addNotificationObserverForTask:task];
&nbsp;&nbsp;&nbsp;&nbsp;[self.lock&nbsp;unlock];
}</pre><p><strong>2.pthread_mutexï¼š</strong><br/><strong>å®é™…é¡¹ç›®ä¸­ï¼š</strong> åœ¨<a href="https://github.com/ibireme/YYKit/blob/3869686e0e560db0b27a7140188fad771e271508/YYKit/Cache/YYMemoryCache.m" target="_blank" rel="nofollow">YYKitçš„YYMemoryCachä¸­å¯ä»¥çœ‹åˆ°</a></p><pre class="line-numbers  language-objectivec">-&nbsp;(instancetype)init&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;...
&nbsp;&nbsp;&nbsp;&nbsp;pthread_mutex_init(&amp;_lock,&nbsp;NULL);
&nbsp;&nbsp;&nbsp;&nbsp;...
&nbsp;&nbsp;&nbsp;&nbsp;
}
&nbsp;&nbsp;&nbsp;&nbsp;
-&nbsp;(void)_trimToCost:(NSUInteger)costLimit&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;BOOL&nbsp;finish&nbsp;=&nbsp;NO;
&nbsp;&nbsp;&nbsp;&nbsp;pthread_mutex_lock(&amp;_lock);
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(costLimit&nbsp;==&nbsp;0)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[_lru&nbsp;removeAll];
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;finish&nbsp;=&nbsp;YES;
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(_lru-&gt;_totalCost&nbsp;&lt;=&nbsp;costLimit)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;finish&nbsp;=&nbsp;YES;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;pthread_mutex_unlock(&amp;_lock);
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(finish)&nbsp;return;
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;NSMutableArray&nbsp;*holder&nbsp;=&nbsp;[NSMutableArray&nbsp;new];
&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;(!finish)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(pthread_mutex_trylock(&amp;_lock)&nbsp;==&nbsp;0)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(_lru-&gt;_totalCost&nbsp;&gt;&nbsp;costLimit)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_YYLinkedMapNode&nbsp;*node&nbsp;=&nbsp;[_lru&nbsp;removeTailNode];
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(node)&nbsp;[holder&nbsp;addObject:node];
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;finish&nbsp;=&nbsp;YES;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pthread_mutex_unlock(&amp;_lock);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;usleep(10&nbsp;*&nbsp;1000);&nbsp;//10&nbsp;ms
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;...
}</pre><p><strong>3.@synchronized:</strong><br/><strong>å®é™…é¡¹ç›®ä¸­ï¼š</strong>AFNetworkingä¸­ isNetworkActivityOccurringå±æ€§çš„getteræ–¹æ³•</p><pre class="line-numbers  language-objectivec">-&nbsp;(BOOL)isNetworkActivityOccurring&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;@synchronized(self)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self.activityCount&nbsp;&gt;&nbsp;0;
&nbsp;&nbsp;&nbsp;&nbsp;}
}</pre><p>å…³äº @synchronizedæ¨èæ‰©å±•é˜…è¯» &nbsp;<a href="http://yulingtianxia.com/blog/2015/11/01/More-than-you-want-to-know-about-synchronized/" target="_blank" rel="nofollow">å…³äº @synchronizedï¼Œè¿™å„¿æ¯”ä½ æƒ³çŸ¥é“çš„è¿˜è¦å¤š</a></p><h2>è‡ªæ—‹é”</h2><p><strong>1.OSSpinLock:</strong></p><pre class="line-numbers  language-csharp">OSSpinLock&nbsp;lock&nbsp;=&nbsp;OS_SPINLOCK_INIT;OSSpinLockLock(&amp;lock);
...
OSSpinLockUnlock(&amp;lock);</pre><p>ä¸Šé¢æ˜¯OSSpinLockä½¿ç”¨æ–¹å¼ï¼Œç¼–è¯‘ä¼šæŠ¥è­¦å‘Šï¼Œå·²ç»åºŸå¼ƒäº†ï¼ŒOSSpinLockå¤§å®¶ä¹Ÿå·²ç»ä¸å†ç”¨å®ƒäº†ï¼Œå› ä¸ºå®ƒåœ¨æŸä¸€äº›åœºæ™¯ä¸‹å·²ç»ä¸å®‰å…¨äº†ï¼Œå¯ä»¥å‚è€ƒ YYå¤§ç¥çš„<a href="https://blog.ibireme.com/2016/01/16/spinlock_is_unsafe_in_ios/" target="_blank" rel="nofollow">ä¸å†å®‰å…¨çš„ OSSpinLock</a>ï¼Œåœ¨Protocol Buffersé¡¹ç›®ä¸­ä½ å¯ä»¥çœ‹åˆ°è¿™æ ·çš„æ³¨é‡Šï¼Œå¤§å®¶å·²ç»ç”¨æ–°çš„æ–¹æ¡ˆæ›¿æ¢äº†ã€‚</p><pre class="line-numbers  language-cpp">&nbsp;//&nbsp;NOTE:&nbsp;OSSpinLock&nbsp;may&nbsp;seem&nbsp;like&nbsp;a&nbsp;good&nbsp;fit&nbsp;here&nbsp;but&nbsp;Apple&nbsp;engineers&nbsp;have
&nbsp;&nbsp;//&nbsp;pointed&nbsp;out&nbsp;that&nbsp;they&nbsp;are&nbsp;vulnerable&nbsp;to&nbsp;live&nbsp;locking&nbsp;on&nbsp;iOS&nbsp;in&nbsp;cases&nbsp;of
&nbsp;&nbsp;//&nbsp;priority&nbsp;inversion:
&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;http://mjtsai.com/blog/2015/12/16/osspinlock-is-unsafe/
&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;https://lists.swift.org/pipermail/swift-dev/Week-of-Mon-20151214/000372.html</pre><p><strong>os_unfair_lock:</strong>(äº’æ–¥é”)<br/>os_unfair_lock æ˜¯è‹¹æœå®˜æ–¹æ¨èçš„æ›¿æ¢OSSpinLockçš„æ–¹æ¡ˆï¼Œä½†æ˜¯å®ƒåœ¨iOS10.0ä»¥ä¸Šçš„ç³»ç»Ÿæ‰å¯ä»¥è°ƒç”¨ã€‚os_unfair_lockæ˜¯ä¸€ç§äº’æ–¥é”ï¼Œå®ƒä¸ä¼šå‘è‡ªæ—‹é”é‚£æ ·å¿™ç­‰ï¼Œè€Œæ˜¯ç­‰å¾…çº¿ç¨‹ä¼šä¼‘çœ ã€‚</p><pre class="line-numbers  language-cpp">os_unfair_lock_t&nbsp;unfairLock;unfairLock&nbsp;=&nbsp;&amp;(OS_UNFAIR_LOCK_INIT);
os_unfair_lock_lock(unfairLock);
os_unfair_lock_unlock(unfairLock);</pre><h2>è¯»å†™é”</h2><p>ä¸Šæ–‡æœ‰è¯´åˆ°ï¼Œè¯»å†™é”åˆç§°å…±äº«-äº’æ–¥é”ï¼Œ<strong>pthread_rwlockï¼Œå®ƒæ˜¯åƒdispatch_barrier_asyncä¸€æ ·ï¼Œå¯ä»¥æä¾›å¤šè¯»å•å†™åŠŸèƒ½çš„ posix APIã€‚</strong></p><pre class="line-numbers  language-cpp">//åŠ è¯»é”pthread_rwlock_rdlock(&amp;rwlock);
//è§£é”pthread_rwlock_unlock(&amp;rwlock);
//åŠ å†™é”pthread_rwlock_wrlock(&amp;rwlock);
//è§£é”pthread_rwlock_unlock(&amp;rwlock);</pre><h2>é€’å½’é”</h2><p>é€’å½’é”æœ‰ä¸€ä¸ªç‰¹ç‚¹ï¼Œå°±æ˜¯åŒä¸€ä¸ªçº¿ç¨‹å¯ä»¥åŠ é”Næ¬¡è€Œä¸ä¼šå¼•å‘æ­»é”ã€‚<br/><strong>1.NSRecursiveLock:</strong><br/>NSRecursiveLockåœ¨<a href="https://github.com/ibireme/YYKit/blob/4e1bd1cfcdb3331244b219cbd37cc9b1ccb62b7a/YYKit/Image/YYWebImageOperation.m" target="_blank" rel="nofollow">YYKitä¸­YYWebImageOperation.m</a>ä¸­æœ‰ç”¨åˆ°ï¼š</p><pre class="line-numbers  language-csharp">_lock&nbsp;=&nbsp;[NSRecursiveLock&nbsp;new];
-&nbsp;(void)dealloc&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;[_lock&nbsp;lock];
&nbsp;&nbsp;&nbsp;&nbsp;...
&nbsp;&nbsp;&nbsp;&nbsp;...
&nbsp;&nbsp;&nbsp;&nbsp;[_lock&nbsp;unlock];
}</pre><p><strong>2.pthread_mutex(recursive):</strong><br/>pthread_mutexé”ä¹Ÿæ”¯æŒé€’å½’ï¼Œåªéœ€è¦è®¾ç½®PTHREAD_MUTEX_RECURSIVEå³å¯</p><p>ï¼ˆå®é™…ä¸Šï¼ŒNSLock,NSRecursiveLock,NSConditionæ˜¯å¯¹pthread_mutex_t å’Œpthread_cond_t çš„å°è£…ï¼‰</p><pre class="line-numbers  language-csharp">pthread_mutex_t&nbsp;lock;
pthread_mutexattr_t&nbsp;attr;
pthread_mutexattr_init(&amp;attr);
pthread_mutexattr_settype(&amp;attr,&nbsp;PTHREAD_MUTEX_RECURSIVE);
pthread_mutex_init(&amp;lock,&nbsp;&amp;attr);
pthread_mutexattr_destroy(&amp;attr);
pthread_mutex_lock(&amp;lock);
pthread_mutex_unlock(&amp;lock);</pre><h2>æ¡ä»¶é”</h2><p><strong>1. NSCondition:</strong><br/><strong>å®šä¹‰ï¼š</strong></p><pre class="line-numbers  language-objectivec">@interface&nbsp;NSCondition&nbsp;:&nbsp;NSObject&nbsp;&lt;NSLocking&gt;&nbsp;
{
@private
&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;*_priv;
}
-&nbsp;(void)wait;
-&nbsp;(BOOL)waitUntilDate:(NSDate&nbsp;*)limit;
-&nbsp;(void)signal;
-&nbsp;(void)broadcast;</pre><p>éµå¾ªNSLockingåè®®ï¼Œä½¿ç”¨çš„æ—¶å€™åŒæ ·æ˜¯lock,unlockåŠ è§£é”ï¼Œwaitæ˜¯å‚»ç­‰ï¼ŒwaitUntilDate:æ–¹æ³•æ˜¯ç­‰ä¸€ä¼šï¼Œéƒ½ä¼šé˜»å¡æ‰çº¿ç¨‹ï¼Œsignalæ˜¯å”¤èµ·ä¸€ä¸ªåœ¨ç­‰å¾…çš„çº¿ç¨‹ï¼Œbroadcastæ˜¯å¹¿æ’­å…¨éƒ¨å”¤èµ·ã€‚</p><pre class="line-numbers  language-csharp">NSCondition&nbsp;*lock&nbsp;=&nbsp;[[NSCondition&nbsp;alloc]&nbsp;init];//Son&nbsp;çº¿ç¨‹dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT,&nbsp;0),&nbsp;^{
&nbsp;&nbsp;&nbsp;&nbsp;[lock&nbsp;lock];
&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;(No&nbsp;Money)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[lock&nbsp;wait];
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;NSLog(@&quot;The&nbsp;money&nbsp;has&nbsp;been&nbsp;used&nbsp;up.&quot;);
&nbsp;&nbsp;&nbsp;&nbsp;[lock&nbsp;unlock];});
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;//Fatherçº¿ç¨‹dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT,&nbsp;0),&nbsp;^{
&nbsp;&nbsp;&nbsp;&nbsp;[lock&nbsp;lock];
&nbsp;&nbsp;&nbsp;&nbsp;NSLog(@&quot;Work&nbsp;hard&nbsp;to&nbsp;make&nbsp;money.&quot;);
&nbsp;&nbsp;&nbsp;&nbsp;[lock&nbsp;signal];
&nbsp;&nbsp;&nbsp;&nbsp;[lock&nbsp;unlock];
});</pre><p><span style="color: rgb(63, 63, 63);">ï¼ˆå®é™…ä¸Šï¼ŒNSLock,NSRecursiveLock,NSConditionæ˜¯å¯¹pthread_mutex_t å’Œpthread_cond_t çš„å°è£…ï¼Œè€ŒNSConditionLockæ˜¯å¯¹NSConditionçš„å°è£…)</span></p><p><strong>2.NSConditionLock:</strong><br/><strong>å®šä¹‰ï¼š</strong></p><pre class="line-numbers  language-objectivec">@interface&nbsp;NSConditionLock&nbsp;:&nbsp;NSObject&nbsp;&lt;NSLocking&gt;&nbsp;{
@private
&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;*_priv;
}
-&nbsp;(instancetype)initWithCondition:(NSInteger)condition
@property&nbsp;(readonly)&nbsp;NSInteger&nbsp;condition;
-&nbsp;(void)lockWhenCondition:(NSInteger)condition;
-&nbsp;(BOOL)tryLock;
-&nbsp;(BOOL)tryLockWhenCondition:(NSInteger)condition;
-&nbsp;(void)unlockWithCondition:(NSInteger)condition;
-&nbsp;(BOOL)lockBeforeDate:(NSDate&nbsp;*)limit;
-&nbsp;(BOOL)lockWhenCondition:(NSInteger)condition&nbsp;beforeDate:(NSDate&nbsp;*)limit;</pre><p>å¾ˆç®€å•ï¼Œæ–¹æ³•å¾ˆæ¸…æ™°ï¼ŒåŸºæœ¬åŒä¸Šã€‚</p><h2>ä¿¡å·é‡</h2><p><strong>dispatch_semaphore:</strong><br/>dispatch_semaphoreåœ¨YYKitä¸­çš„<a href="https://github.com/ibireme/YYKit/blob/3869686e0e560db0b27a7140188fad771e271508/YYKit/Utility/YYThreadSafeArray.m" target="_blank" rel="nofollow">YYThreadSafeArray.m</a>æœ‰æ‰€åº”ç”¨ï¼ŒYYå¤§ç¥æœ‰è¿™æ ·ä¸€å¥æ³¨é‡Šï¼š</p><pre class="line-numbers  language-cpp">@discussion&nbsp;Generally,&nbsp;access&nbsp;performance&nbsp;is&nbsp;lower&nbsp;than&nbsp;NSMutableArray,&nbsp;
&nbsp;but&nbsp;higher&nbsp;than&nbsp;using&nbsp;@synchronized,&nbsp;NSLock,&nbsp;or&nbsp;pthread_mutex_t.</pre><pre class="line-numbers  language-cpp">#define&nbsp;LOCK(...)&nbsp;
dispatch_semaphore_wait(_lock,&nbsp;DISPATCH_TIME_FOREVER);

dispatch_semaphore_signal(_lock);</pre><p>æ›´å¤šä¿¡å·é‡çš„ä»‹ç»è§ä¸‹èŠ‚</p><h2>æ€»ç»“ï¼š</h2><p>å…¶å®æœ¬æ–‡å†™çš„éƒ½æ˜¯ä¸€äº›å†åŸºç¡€ä¸è¿‡çš„å†…å®¹ï¼Œåœ¨å¹³æ—¶é˜…è¯»ä¸€äº›å¼€æºé¡¹ç›®çš„æ—¶å€™ç»å¸¸ä¼šé‡åˆ°ä¸€äº›ä¿æŒçº¿ç¨‹åŒæ­¥çš„æ–¹å¼ï¼Œå› ä¸ºåœºæ™¯ä¸åŒå¯èƒ½é€‰å‹ä¸åŒï¼Œè¿™ç¯‡å°±åšä¸€ä¸‹ç®€å•çš„è®°å½•å§~æˆ‘ç›¸ä¿¡è¯»å®Œè¿™ç¯‡ä½ åº”è¯¥èƒ½æ ¹æ®ä¸åŒåœºæ™¯é€‰æ‹©åˆé€‚çš„é”äº†å§ã€èƒ½å¤Ÿé“å‡º<code>è‡ªæ—‹é”</code>å’Œ<code>äº’æ–¥é”</code>çš„åŒºåˆ«äº†å§ã€‚</p><p><br/>ä½œè€…ï¼šSuperMario_Nil<br/>é“¾æ¥ï¼šhttps://www.jianshu.com/p/b1edc6b0937a<br/>æ¥æºï¼šç®€ä¹¦<br/>è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p><p><br/></p>
             </div>
         </div>
        <div class="row" style="background-color: #eeeeee;">
            
             <div class="col-sm-4 text-left left-arror">
                 
             </div>
       
             <div class="col-sm-4 col-sm-offset-4 text-right right-arror">
                
             </div>
        
         </div>

    </div>
</div>
<div class="row">
    <div class="col-sm-12 text-center" style="padding-top: 10px;">
        <a href="https://www.onlinegdb.com/" target="_blank"><strong><font color="black">åœ¨çº¿ç¼–ç¨‹å·¥å…·</font></strong></a>
    </div>
</div>
</div>
<script type="text/javascript">
// var siteHome = './';
var tutorial_id = 'a948A25C';
var article_id = 'C5C1C965';
</script>

	
	<a href="https://beian.miit.gov.cn"><div style="text-align: center; height: 60px;padding-top: 20px;">é„‚ICPå¤‡20003145å·-1</div></a>	
	
</body>