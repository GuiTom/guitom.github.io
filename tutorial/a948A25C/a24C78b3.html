<!-- <!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd"> -->

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
 	<meta name="description" content="编程">
 	<meta name="keywords" content="IT教程 ">
    <meta name="viewport" content="width=device-width, initial-scale=1 , user-scalable=no">
    
<!-- <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/> -->
<title>内存管理-iOS开发(高级篇)</title>


    

	<link rel="stylesheet" href="/lib/css/bootstrap.min.css">
    <link rel="stylesheet" href="/lib/css/bootstrap-maizi.css">
    <link rel="stylesheet" href="/lib/css/animate.css">
    <!-- <script  src="https://libs.baidu.com/jquery/1.10.2/jquery.min.js"></script> -->
    <script src="/lib/js/jquery.min.js"></script>
    <script src="/lib/js/bootstrap.min.js"></script>
    
    <script src="/lib/js/jquery.singlePageNav.min.js"></script>
    <script src="/lib/js/jquery.cookie.js"></script>
    
	
<script src="/js/article.js"></script>
<!--百度统计-->
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?a684a10bc59d54f03381c502765556bb";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


<script type="text/javascript">
    // var siteHome = './';
    var staticHTMLUri = '/';
</script>


</head>
<body>
	
		  
		   <div style="height:50px;margin-bottom: 0px;"><nav class="navbar navbar-default navbar-fixed-top" id="topNav">		   <div class="container"> 
		    <!--导航--> 
		    <!--小屏幕导航按钮和logo--> 
		    <div class="navbar-header"> 
		     <button class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> 
		     <a href="https://guitom.github.io/" class="navbar-brand" style="color: #1196EE;"><span>趣通小教程</span>&nbsp;<span>guitom.github.io</span></a> 
		    </div> 
		    <!--小屏幕导航按钮和logo--> 
		    <div class="navbar-collapse collapse"> 
		     <div class="profile navbar-right"> 
			      <!-- 	<ul class="nav navbar-nav"> 
			       		<li><a href="#home" data-toggle="modal" id="collector">收藏夹</a></li>
			       		<li><a href="#home" data-toggle="modal" id="homePageloginBtn">登录</a></li> 
			      		<li><a href="#home" data-toggle="modal" id="loginStatus"></a></li> 
			      	</ul>  -->
		      		
		     </div> 
		     <ul class="nav navbar-nav navbar-center"> 
		      <li> 
		       <!--搜索框--> 
		       <div class="input-group hidden" id="searchBox" style="max-width:300px;height:30px;margin-top:10px;"> 
		        <input type="text" class="form-control input-md" placeholder="输入关键词" onkeydown="onKeyDown(event)" /> 
		        <span class="input-group-addon btn btn-primary">搜索</span> 
		       </div> 
		       <!--搜索框--></li> 
	
		     </ul> 
		    </div> 
		   </div> </nav></div>
		  
	
	
<style type="text/css">
    .panel-heading{
        padding-top: 5px;
        padding-right: 5px;
    }
    .panel-body {
        padding: 10px;
    }
    .panel-body div {
        padding-left: 20px;
    }

    .menu-container{
        border-width: 2px;
        border-radius: 5px;
        border-color: green;
        border:5px solid #f6f4f0;
    
    }
    .menu-container div{
        padding-right: 10px;
        padding-left: 10px;
        line-height: 30px;
    }
    .chapter{
        background-color: #f0f0f0;
        font-weight: bold;

    }
    .course{
        background-color: #e2e2e2;
        text-indent: 0em;
    }
    .normal{
        color: black;
    }
    .selected{
        background-color: #1196EE;
        color: white;
    }
    .block{
        /*border: thick solid #e1e1e1;*/
        
    }
    .preview{
        display: none;
    }
    .item{
        border-bottom-style:solid;
        border-width: 1px;
        border-color: #f1f1f1;
        cursor:pointer;
    }
    .content{
        border-radius: 5px;
    }
    a:hover{
        text-decoration: none;
    }
    body{
        background-color: #dfdfdf;
    }
    td {
        border: 1px solid #ddd
    }
</style>
<div class="container">
<!-- <div class="row">
    <div class="col-sm-12" style="background-color: white;border-radius:8px;border-style: solid;border-color:#dfdfdf ">
        
    </div>
</div> -->
<div class="row">
    <div class="col-sm-12 text-center" style="padding-top: 20px;">
        <strong>内存管理-iOS开发(高级篇)</strong>
    </div>
</div>
<div class="row" style="margin-top:5px;">
    <div class="col-sm-2" style="overflow-y: auto;max-height:100%;overflow-x: hidden;">
                <div class="menu-container">
                    <div id="06024caB" class="item chapter normal selected">Runtime</div>

<div id="5b514C5a" class="item course normal">方法交换</div>
<div id="67C92673" class="item course normal">动态添加方法</div>
<div id="8A546ac3" class="item course normal">关联对象</div><div id="39c93aA5" class="item course normal">KVO的实现</div><div id="93C8046a" class="item chapter normal">内存管理</div><div id="c1944c7C" class="item course normal">TaggedPointer</div><div id="3ABca2ab" class="item course normal">小测验</div><div id="AAB71A4b" class="item course normal">NONPOINTER_ISA</div><div id="3Ac50559" class="item course normal">散列表 </div><div id="8BA7CC22" class="item course normal">Copy和mutableCopy</div><div id="6B5C7c25" class="item course normal">对象的销毁dealloc</div><div id="97cc9C51" class="item course normal">常用lldb命令</div>


































<div id="9ccab66A" class="item chapter normal">RunLoop</div><div id="3C6a652B" class="item course normal">NSTimer应用</div><div id="07A53392" class="item course normal">线程保活</div><div id="4a6ac2bb" class="item course normal">UIImage空闲时渲染</div><div id="A5bCb944" class="item course normal">线程间通信(NSPort)</div><div id="471ab021" class="item course normal">卡顿检测</div><div id="30A6AA7A" class="item course normal">自动释放池</div><div id="2A662A6A" class="item chapter normal">UI视图</div><div id="4b1Aa8ba" class="item course normal">UI绘制原理</div><div id="C1AB418B" class="item course normal">UI事件传递机制</div><div id="3C991812" class="item course normal">事件传递相关练习题</div><div id="12B75430" class="item course normal">事件响应链</div><div id="4Cc0CC83" class="item course normal">相关面试题</div><div id="0CbB19c9" class="item chapter normal">多线程</div><div id="217b960B" class="item course normal">pthread</div><div id="53870C1a" class="item course normal">NSThread</div><div id="3a61B9a4" class="item course normal">GCD基础API(1)</div><div id="88bB0879" class="item course normal">GCD基础API(2)</div><div id="cc300B3b" class="item course normal">GCD经典面试题</div><div id="29108B1C" class="item course normal">GCD高级 API</div><div id="8BC7b1B3" class="item course normal">NSOpreation</div><div id="4635Bb8A" class="item course normal">多线程面试题</div><div id="C5C1C965" class="item course normal">锁</div><div id="28c98C11" class="item course normal">锁相关面试题</div><div id="B529829C" class="item course normal">信号量</div><div id="8a900c58" class="item chapter normal">OC语言</div><div id="A01181B1" class="item course normal">属性关键字</div><div id="a24C78b3" class="item course normal">内存管理</div><div id="1472b4c0" class="item course normal">KVO</div><div id="BC924416" class="item chapter normal">block及其本质</div><div id="61a4a56A" class="item course normal">block按存储区分类</div><div id="C3803054" class="item course normal">变量截取</div><div id="Cc14A93c" class="item course normal">相关面试题</div><div id="a6a97753" class="item chapter normal">第三方库</div><div id="14ab67AB" class="item course normal">AFNetWorking</div><div id="6A235a3B" class="item course normal">SDWebImageView</div><div id="2c7C0120" class="item course normal">ReactiveCocoa</div><div id="a5488b6B" class="item course normal">AsyncDisplayKit</div><div id="B5b3B053" class="item chapter normal">性能优化</div><div id="0A415471" class="item course normal">UI卡顿优化</div><div id="C094BcBc" class="item course normal">离屏渲染优化</div><div id="b2b21885" class="item course normal">卡顿检测</div><div id="56529C54" class="item course normal">电量优化</div><div id="AcaAbB32" class="item course normal">APP冷启动优化</div>
                </div>
                <div style="float:left;margin-top: 30px;width: 1px;height: 100%;background: darkgray;"></div>
        </div>
    <div class="col-sm-10 content" style="overflow-y: auto;height: 100%;background-color: white;padding-top:20px;">
         <div class="row">
             <div class="col-sm-12">
                 <h1 style="font-size: 28px; margin: 0px; border: 0px; padding: 0px; line-height: 38px; color: rgb(25, 25, 25);">iOS内存管理（MRC、ARC）深入浅出&nbsp;<span class="article-tag" style="border: 0px; margin: 0px; padding: 0px; display: inline-block; font-weight: 400; position: relative; top: -4px;"></span></h1><p><span class="time" id="news-time" data-val="1523098860000" style="border: 0px; margin: 0px; padding: 0px;">2018-04-07 19:01</span></p><p><br/></p><article class="article" id="mp-editor" style="border: 0px; margin: 0px; padding: 5px 0px 0px; color: rgb(25, 25, 25); line-height: 1.9; overflow: hidden auto; box-sizing: border-box; outline: 0px; tab-size: 4; overflow-wrap: break-word; width: 640px; font-family: &quot;PingFang SC&quot;, Arial, 微软雅黑, 宋体, simsun, sans-serif; white-space: normal; background-color: rgb(255, 255, 255);"><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="font-weight: 700; border: 0px; margin: 0px; padding: 0px;">内存管理方式</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">首先明确一点，无论在MRC还是ARC情况下，Objective-C采用的是引用计数式的内存管理方式，这一方式的特点：</span></p><ul style="list-style-type: none;" class=" list-paddingleft-2"><li><p>自己生成的对象，自己持有。例如：NSObject * __strong obj = [[NSObject alloc]init];。</p></li><li><p>非自己生成的对象，自己也能持有。例如：NSMutableArray * __strong array = [NSMutableArray array];。</p></li><li><p>不再需要自己持有对象时释放。</p></li><li><p>无法释放非自己持有的对象。</p></li></ul><table><tbody style="margin: 0px; padding: 0px;"><tr style="margin: 0px; padding: 0px;" class="firstRow"><th style="padding: 0px; margin: 0px;">对象操作</th><th style="padding: 0px; margin: 0px;">Objective-C方法</th></tr><tr style="margin: 0px; padding: 0px;"><td style="padding: 9px 15px; margin: 0px; font-size: 14px; background: rgb(248, 247, 243); line-height: 26px;">生成并持有对象</td><td style="padding: 9px 15px; margin: 0px; font-size: 14px; background: rgb(248, 247, 243); line-height: 26px;">alloc/new/copy/mutableCopy等方法</td></tr><tr style="margin: 0px; padding: 0px;"><td style="padding: 9px 15px; margin: 0px; font-size: 14px; background: rgb(248, 247, 243); line-height: 26px;">持有对象</td><td style="padding: 9px 15px; margin: 0px; font-size: 14px; background: rgb(248, 247, 243); line-height: 26px;">retain方法</td></tr><tr style="margin: 0px; padding: 0px;"><td style="padding: 9px 15px; margin: 0px; font-size: 14px; background: rgb(248, 247, 243); line-height: 26px;">释放对象</td><td style="padding: 9px 15px; margin: 0px; font-size: 14px; background: rgb(248, 247, 243); line-height: 26px;">release方法</td></tr><tr style="margin: 0px; padding: 0px;"><td style="padding: 9px 15px; margin: 0px; font-size: 14px; background: rgb(248, 247, 243); line-height: 26px;">废弃对象</td><td style="padding: 9px 15px; margin: 0px; font-size: 14px; background: rgb(248, 247, 243); line-height: 26px;">dealloc方法</td></tr></tbody></table><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px; font-size: 20px;"><span style="font-weight: 700; border: 0px; margin: 0px; padding: 0px;">自己生成的对象，自己持有</span></span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">在iOS内存管理中有四个关键字，alloc、new、copy、mutableCopy，自身使用这些关键字产生对象,那么自身就持有了对象</span></p><blockquote style="border-width: 0px 0px 0px 4px; border-top-style: initial; border-right-style: initial; border-bottom-style: initial; border-left-style: solid; border-top-color: initial; border-right-color: initial; border-bottom-color: initial; border-left-color: rgb(204, 204, 204); border-image: initial; margin: 0.63em 0px 0px; padding: 0px 0px 0px 16px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;">// 使用了alloc分配了内存，obj指向了对象，该对象本身引用计数为1,不需要retain</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;">id obj = [[NSObject alloc] init];</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;">// 使用了new分配了内存,objc指向了对象，该对象本身引用计数为1，不需要retain</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;">id obj = [NSObject new];</span></p></blockquote><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px; font-size: 20px;"><span style="font-weight: 700; border: 0px; margin: 0px; padding: 0px;">非自己生成的对象，自己也能持有</span></span></p><blockquote style="border-width: 0px 0px 0px 4px; border-top-style: initial; border-right-style: initial; border-bottom-style: initial; border-left-style: solid; border-top-color: initial; border-right-color: initial; border-bottom-color: initial; border-left-color: rgb(204, 204, 204); border-image: initial; margin: 0.63em 0px 0px; padding: 0px 0px 0px 16px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;">// NSMutableArray通过类方法array产生了对象(并没有使用alloc、new、copy、mutableCopt来产生对象),因此该对象不属于obj自身产生的</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;">// 因此，需要使用retain方法让对象计数器+1,从而obj可以持有该对象(尽管该对象不是他产生的)</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;">id obj = [NSMutableArray array];</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;">[obj retain];</span></p></blockquote><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px; font-size: 20px;"><span style="font-weight: 700; border: 0px; margin: 0px; padding: 0px;">不再需要自己持有对象时释放</span></span></p><blockquote style="border-width: 0px 0px 0px 4px; border-top-style: initial; border-right-style: initial; border-bottom-style: initial; border-left-style: solid; border-top-color: initial; border-right-color: initial; border-bottom-color: initial; border-left-color: rgb(204, 204, 204); border-image: initial; margin: 0.63em 0px 0px; padding: 0px 0px 0px 16px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;">id obj = [NSMutableArray array];</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;">[obj retain];</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;">// 当obj不在需要持有的对象，那么，obj应该发送release消息</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;">[obj release];</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;">// 释放了对象还进行释放,会导致奔溃</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;">[obj release];</span></p></blockquote><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px; font-size: 20px;"><span style="font-weight: 700; border: 0px; margin: 0px; padding: 0px;">无法释放非自己持有的对象</span></span></p><blockquote style="border-width: 0px 0px 0px 4px; border-top-style: initial; border-right-style: initial; border-bottom-style: initial; border-left-style: solid; border-top-color: initial; border-right-color: initial; border-bottom-color: initial; border-left-color: rgb(204, 204, 204); border-image: initial; margin: 0.63em 0px 0px; padding: 0px 0px 0px 16px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;">// 释放一个不属于自己的对象</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;">id obj = [NSMutableArray array];</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;">// obj没有进行retain操作而进行release操作，然后autoreleasePool也会对其进行一次release操作，导致奔溃。</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;">后面会讲到autorelease。</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;">[obj release];</span></p></blockquote><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px; font-size: 20px;"><span style="font-weight: 700; border: 0px; margin: 0px; padding: 0px;">针对[NSMutableArray array]方法取得的对象存在，自己却不持有对象，底层大致实现：</span></span></p><blockquote style="border-width: 0px 0px 0px 4px; border-top-style: initial; border-right-style: initial; border-bottom-style: initial; border-left-style: solid; border-top-color: initial; border-right-color: initial; border-bottom-color: initial; border-left-color: rgb(204, 204, 204); border-image: initial; margin: 0.63em 0px 0px; padding: 0px 0px 0px 16px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;">+ (id)object {</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;">//自己持有对象</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;">id obj = [[NSObject alloc]init];</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;">[obj autorelease];</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;">//取得的对象存在，但自己不持有对象</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;">return obj;</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;">}</span></p></blockquote><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">使用了autorelease方法，将obj注册到autoreleasePool中，不会立即释放，当pool结束时再自动调用release。这样达到取得的对象存在，自己不持有对象。</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px; font-size: 20px;"><span style="font-weight: 700; border: 0px; margin: 0px; padding: 0px;">autorelease</span></span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">顾名思义：autorelease就是自动释放，它和C语言的局部变量类似，C语言局部变量在程序执行时，超出其作用域时，会被自动废弃。autorelease会像C语言局部变量那样对待对象实例，当超出作用域时，对象实例的release实例方法会被调用。我们可以设定autorelease的作用域。</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="font-weight: 700; border: 0px; margin: 0px; padding: 0px;">autorelease具体使用方法</span></p><ul style="list-style-type: none;" class=" list-paddingleft-2"><li><p>生成并持有NSAutoreleasePool对象</p></li><li><p>调用已分配对象的autorelease实例方法</p></li><li><p>废弃NSAutoreleasePool对象</p></li></ul><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: center;"><img src="/upload/image/20191117/213439943162.png" style="border: 0px; margin: 10px auto 0px; padding: 0px; display: block; max-width: 100%; height: auto;"/></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: center;"><span style="border: 0px; margin: 0px; padding: 0px;">NSAutoreleasePool生命周期</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">NSAutoreleasePool对象的生命周期就是一个作用域，对于所有调用过autorelease实例方法的对象，在废弃NSAutoreleasePool对象时，都会调用其release实例方法。如上图所示。</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">用源代码表示如下：</span></p><blockquote style="border-width: 0px 0px 0px 4px; border-top-style: initial; border-right-style: initial; border-bottom-style: initial; border-left-style: solid; border-top-color: initial; border-right-color: initial; border-bottom-color: initial; border-left-color: rgb(204, 204, 204); border-image: initial; margin: 0.63em 0px 0px; padding: 0px 0px 0px 16px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init];</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">id obj = [[NSObject alloc] init];</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">[obj autorelease];</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">[pool drain];</span></p></blockquote><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">在[pool drain]调用时，NSAutoreleasePool被销毁，obj的release方法会被触发。obj被释放。</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px; font-size: 20px;"><span style="font-weight: 700; border: 0px; margin: 0px; padding: 0px;">autorelease苹果实现</span></span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">可以通过objc4库的runtime/objc-arr.mm来确认苹果中autorelease的实现。</span></p><p class="p1" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(65, 161, 192); background-color: rgb(31, 32, 41); white-space: normal;"><span class="s1" style="color: rgb(29, 169, 162);">class</span><span class="s2" style="color: rgb(225, 226, 231);"> </span>AutoreleasePoolPage</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;">{</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p4" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(215, 0, 143); background-color: rgb(31, 32, 41); white-space: normal;">static<span class="s2" style="color: rgb(225, 226, 231);"> </span>inline<span class="s2" style="color: rgb(225, 226, 231);"> </span>void<span class="s2" style="color: rgb(225, 226, 231);"> *push()</span></p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;">{</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;">相当于生成或持有NSAutoreleasePool类对象</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;">}</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p4" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(215, 0, 143); background-color: rgb(31, 32, 41); white-space: normal;">static<span class="s2" style="color: rgb(225, 226, 231);"> </span>inline<span class="s2" style="color: rgb(225, 226, 231);"> </span>void<span class="s2" style="color: rgb(225, 226, 231);"> *pop(</span>void<span class="s2" style="color: rgb(225, 226, 231);"> *token)</span></p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;">{</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;">相当于废弃NSAutoreleasePool类对象</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;">releaseAll();</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;">}</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;"><span class="s3" style="color: rgb(215, 0, 143);">static</span> <span class="s3" style="color: rgb(215, 0, 143);">inline</span> <span class="s3" style="color: rgb(215, 0, 143);">id</span> autorelease(<span class="s3" style="color: rgb(215, 0, 143);">id</span> obj)</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;">{</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;">相当于NSAutoreleasePool类的addObject类方法</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;">AutoreleasePoolPage *autoreleasePoolPage = 取得正在使用的AutoreleasePoolPage实例;</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;">autoreleasePoolPage-&gt;add(obj);</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;">}</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;"><span class="s3" style="color: rgb(215, 0, 143);">id</span> *add(<span class="s3" style="color: rgb(215, 0, 143);">id</span> obj)</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;">{</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;">将对象追加到内部数组中</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;">}</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;"><span class="s3" style="color: rgb(215, 0, 143);">void</span> releaseAll()</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;">{</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;">调用内部数组中对象的release实例方法</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;">}</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;">};</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p1" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(65, 161, 192); background-color: rgb(31, 32, 41); white-space: normal;"><span class="s3" style="color: rgb(215, 0, 143);">void</span><span class="s2" style="color: rgb(225, 226, 231);"> *</span>objc_autoreleasePoolPush<span class="s2" style="color: rgb(225, 226, 231);">(</span><span class="s3" style="color: rgb(215, 0, 143);">void</span><span class="s2" style="color: rgb(225, 226, 231);">)</span></p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;">{</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p5" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(29, 169, 162); background-color: rgb(31, 32, 41); white-space: normal;"><span class="s3" style="color: rgb(215, 0, 143);">return</span><span class="s2" style="color: rgb(225, 226, 231);"> </span>AutoreleasePoolPage<span class="s2" style="color: rgb(225, 226, 231);">::push();</span></p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;">}</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p1" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(65, 161, 192); background-color: rgb(31, 32, 41); white-space: normal;"><span class="s3" style="color: rgb(215, 0, 143);">void</span><span class="s2" style="color: rgb(225, 226, 231);"> </span>objc_autoreleasePoolPop<span class="s2" style="color: rgb(225, 226, 231);">(</span><span class="s3" style="color: rgb(215, 0, 143);">void</span><span class="s2" style="color: rgb(225, 226, 231);"> *ctxt)</span></p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;">{</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;">AutoreleasePoolPage::pop(ctxt);</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;">}</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p1" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(65, 161, 192); background-color: rgb(31, 32, 41); white-space: normal;"><span class="s3" style="color: rgb(215, 0, 143);">id</span><span class="s2" style="color: rgb(225, 226, 231);"> *</span>objc_autorelease<span class="s2" style="color: rgb(225, 226, 231);">(</span><span class="s3" style="color: rgb(215, 0, 143);">id</span><span class="s2" style="color: rgb(225, 226, 231);"> obj)</span></p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;">{</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;"><span class="s3" style="color: rgb(215, 0, 143);">return</span> <span class="s1" style="color: rgb(29, 169, 162);">AutoreleasePoolPage</span>::autorelease(obj);</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;">}</p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">我们使用调速器来观察NSAutoreleasePool类方法和autorelease方法的运行过程，如下所示，这些方法调用了关联于objc4库autorelease实现的函数。</span><br/></p><blockquote style="border-width: 0px 0px 0px 4px; border-top-style: initial; border-right-style: initial; border-bottom-style: initial; border-left-style: solid; border-top-color: initial; border-right-color: initial; border-bottom-color: initial; border-left-color: rgb(204, 204, 204); border-image: initial; margin: 0.63em 0px 0px; padding: 0px 0px 0px 16px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><p class="p1" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(69, 187, 62); background-color: rgb(31, 32, 41); white-space: normal;">//等同于objc_autoreleasePoolPush()</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(37, 144, 141); background-color: rgb(31, 32, 41); white-space: normal;">NSAutoreleasePool<span class="s1" style="color: rgb(225, 226, 231);"> *</span><span class="s2" style="color: rgb(65, 161, 192);">pool</span><span class="s1" style="color: rgb(225, 226, 231);"> = [[</span>NSAutoreleasePool<span class="s1" style="color: rgb(225, 226, 231);"> </span>alloc<span class="s1" style="color: rgb(225, 226, 231);">] </span>init<span class="s1" style="color: rgb(225, 226, 231);">];</span></p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(37, 144, 141); background-color: rgb(31, 32, 41); white-space: normal;"><span class="s3" style="color: rgb(215, 0, 143);">id</span><span class="s1" style="color: rgb(225, 226, 231);"> </span><span class="s2" style="color: rgb(65, 161, 192);">obj</span><span class="s1" style="color: rgb(225, 226, 231);"> = [[</span>NSObject<span class="s1" style="color: rgb(225, 226, 231);"> </span>alloc<span class="s1" style="color: rgb(225, 226, 231);">] </span>init<span class="s1" style="color: rgb(225, 226, 231);">];</span></p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p1" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(69, 187, 62); background-color: rgb(31, 32, 41); white-space: normal;">//等同于objc_autorelease(obj)</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p4" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;">[obj autorelease];</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p1" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(69, 187, 62); background-color: rgb(31, 32, 41); white-space: normal;">//等同于objc_autoreleasePoolPop(pool)</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p4" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;">[pool drain];</p><p class="p5" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgba(34, 160, 85, 0.45); background-color: rgb(31, 32, 41); white-space: normal;">/**</p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><br/></p></blockquote><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">在iOS程序启动后，主线程会自动创建一个RunLoop，苹果在主线程 RunLoop 里注册了两个 Observer，其回调都是 _wrapRunLoopWithAutoreleasePoolHandler()。</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">第一个 Observer 监视的事件是 Entry(即将进入Loop)，其回调内会调用 _objc_autoreleasePoolPush() 创建自动释放池。其 order 是-2147483647，优先级最高，保证创建释放池发生在其他所有回调之前。</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">第二个 Observer 监视了两个事件： BeforeWaiting(准备进入休眠) 时调用_objc_autoreleasePoolPop() 和 _objc_autoreleasePoolPush() 释放旧的池并创建新池；Exit(即将退出Loop) 时调用 _objc_autoreleasePoolPop() 来释放自动释放池。这个 Observer 的 order 是 2147483647，优先级最低，保证其释放池子发生在其他所有回调之后。</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">在主线程执行的代码，通常是写在诸如事件回调、Timer回调内的。这些回调会被 RunLoop 创建好的 AutoreleasePool 环绕着，所以不会出现内存泄漏，开发者也不一定非得显示创建 Pool 了。runloop相关</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">尽管如此，在大量产生autorelease的对象时，只要NSAutoreleasePool没有被废弃，那么产生的对象就不能被释放，因此会产生内存不足的现象。例如：</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">读入大量图像的同时改变其尺寸。图像文件读入到NSData对象，并从中生成UIImage对象，改变该对象尺寸后生成新的UIImage对象。这种情况会产生大量autorelease对象。</span></p><blockquote style="border-width: 0px 0px 0px 4px; border-top-style: initial; border-right-style: initial; border-bottom-style: initial; border-left-style: solid; border-top-color: initial; border-right-color: initial; border-bottom-color: initial; border-left-color: rgb(204, 204, 204); border-image: initial; margin: 0.63em 0px 0px; padding: 0px 0px 0px 16px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;">for (int i = 0; i &lt; 图片数; ++ i) {</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;">/*</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;">读入图片</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;">大量产生autorelease的对象</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;">由于没有废弃NSAutoreleasePool对象</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;">导致产生内存峰值，可能内存不足而奔溃</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;">*/</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;">}</span></p></blockquote><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">在这种情况下，应当在适当的位置生成、持有或废弃NSAutoreleasePool对象</span></p><blockquote style="border-width: 0px 0px 0px 4px; border-top-style: initial; border-right-style: initial; border-bottom-style: initial; border-left-style: solid; border-top-color: initial; border-right-color: initial; border-bottom-color: initial; border-left-color: rgb(204, 204, 204); border-image: initial; margin: 0.63em 0px 0px; padding: 0px 0px 0px 16px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;">for (int i = 0; i &lt; 图片数; ++ i) {</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;">NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init];</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;">/*</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;">读入图片</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;">大量产生autorelease的对象</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;">*/</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;">[pool drain];</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;">/*</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;">通过释放pool</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;">autorelease的对象被release，就不会产生内存峰值</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;">*/</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;">}</span></p></blockquote><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">使用容器的block版本的枚举器时，内部会自动添加一个AutoreleasePool：</span></p><blockquote style="border-width: 0px 0px 0px 4px; border-top-style: initial; border-right-style: initial; border-bottom-style: initial; border-left-style: solid; border-top-color: initial; border-right-color: initial; border-bottom-color: initial; border-left-color: rgb(204, 204, 204); border-image: initial; margin: 0.63em 0px 0px; padding: 0px 0px 0px 16px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;">[array enumerateObjectsUsingBlock:^(id obj, NSUInteger idx, BOOL *stop) {</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;">// 这里被一个局部@autoreleasepool包围着</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;">}];</span></p></blockquote><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px; font-size: 20px;"><span style="font-weight: 700; border: 0px; margin: 0px; padding: 0px;">所有权修饰符及其原理</span></span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">在 ARC 特性下有 4 种与内存管理息息相关的变量所有权修饰符值得我们关注：</span></p><ul style="list-style-type: none;" class=" list-paddingleft-2"><li><p>__strong</p></li><li><p>__weak</p></li><li><p>__unsafe_unretaied</p></li><li><p>__autoreleasing</p></li></ul><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">说到变量所有权修饰符，有人可能会跟属性修饰符搞混，这里做一个对照关系小结：</span></p><ul style="list-style-type: none;" class=" list-paddingleft-2"><li><p>assign 对应的所有权类型是 __unsafe_unretained。</p></li><li><p>copy 对应的所有权类型是 __strong。</p></li><li><p>retain 对应的所有权类型是 __strong。</p></li><li><p>strong 对应的所有权类型是 __strong。</p></li><li><p>unsafe_unretained对应的所有权类型是__unsafe_unretained。</p></li><li><p>weak 对应的所有权类型是 __weak。</p></li></ul><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px; font-size: 20px;"><span style="font-weight: 700; border: 0px; margin: 0px; padding: 0px;">__strong</span></span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">__strong 表示强引用，对应定义 property 时用到的 strong。当对象没有任何一个强引用指向它时，它才会被释放。如果在声明引用时不加修饰符，那么引用将默认是强引用。当需要释放强引用指向的对象时，需要保证所有指向对象强引用置为 nil。__strong 修饰符是 id 类型和对象类型默认的所有权修饰符。</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px; font-size: 20px;"><span style="font-weight: 700; border: 0px; margin: 0px; padding: 0px;">原理：</span></span></p><blockquote style="border-width: 0px 0px 0px 4px; border-top-style: initial; border-right-style: initial; border-bottom-style: initial; border-left-style: solid; border-top-color: initial; border-right-color: initial; border-bottom-color: initial; border-left-color: rgb(204, 204, 204); border-image: initial; margin: 0.63em 0px 0px; padding: 0px 0px 0px 16px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><p class="p1" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;">{</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p1" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;"><span class="s1" style="color: rgb(215, 0, 143);">id</span> <span class="s1" style="color: rgb(215, 0, 143);">__strong</span> obj = [[NSObject alloc] init];</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p1" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;">}</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(69, 187, 62); background-color: rgb(31, 32, 41); white-space: normal;">//编译器的模拟代码</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p1" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;"><span class="s1" style="color: rgb(215, 0, 143);">id</span> <span class="s2" style="color: rgb(65, 161, 192);">obj</span> = objc_msgSend(NSObject,<span class="s1" style="color: rgb(215, 0, 143);">@selector</span>(alloc));</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p1" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;"><span class="s2" style="color: rgb(65, 161, 192);">objc_msgSend</span>(obj,<span class="s1" style="color: rgb(215, 0, 143);">@selector</span>(init));</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(69, 187, 62); background-color: rgb(31, 32, 41); white-space: normal;">// 出作用域的时候调用</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p4" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(65, 161, 192); background-color: rgb(31, 32, 41); white-space: normal;">objc_release<span class="s3" style="color: rgb(225, 226, 231);">(obj);</span></p><p class="p4" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(65, 161, 192); background-color: rgb(31, 32, 41); white-space: normal;"><span class="s3" style="color: rgb(225, 226, 231);"><br/></span></p><p class="p4" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(65, 161, 192); background-color: rgb(31, 32, 41); white-space: normal;"><span class="s3" style="color: rgb(225, 226, 231);"><br/></span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><br/></p></blockquote><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">虽然ARC有效时不能使用release方法，但由此可知编译器自动插入了release。</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">对象是通过除alloc、new、copy、multyCopy外方法产生的情况</span></p><blockquote style="border-width: 0px 0px 0px 4px; border-top-style: initial; border-right-style: initial; border-bottom-style: initial; border-left-style: solid; border-top-color: initial; border-right-color: initial; border-bottom-color: initial; border-left-color: rgb(204, 204, 204); border-image: initial; margin: 0.63em 0px 0px; padding: 0px 0px 0px 16px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="text-align: justify;"></span></p><p class="p1" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(65, 161, 192); background-color: rgb(31, 32, 41); white-space: normal;"><br/></p><p class="p1" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(65, 161, 192); background-color: rgb(31, 32, 41); white-space: normal;">@autoeleasepool<span class="s1" style="color: rgb(225, 226, 231);"> {</span></p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(69, 187, 62); background-color: rgb(31, 32, 41); white-space: normal;">// 如果看了上面__strong的原理，就知道实际上对象已经注册到自动释放池里面了</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p4" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;"><span class="s2" style="color: rgb(215, 0, 143);">id</span> <span class="s2" style="color: rgb(215, 0, 143);">__autoreleasing</span> obj = [[NSObject alloc] init];</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p4" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;">}</p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="text-align: justify;">结果与之前稍有不同：</span><br/></p></blockquote><blockquote style="border-width: 0px 0px 0px 4px; border-top-style: initial; border-right-style: initial; border-bottom-style: initial; border-left-style: solid; border-top-color: initial; border-right-color: initial; border-bottom-color: initial; border-left-color: rgb(204, 204, 204); border-image: initial; margin: 0.63em 0px 0px; padding: 0px 0px 0px 16px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;">//编译器的模拟代码</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;"></span></p><p class="p1" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;"><span class="s1" style="color: rgb(215, 0, 143);"><br/></span></p><p class="p1" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;"><span class="s1" style="color: rgb(215, 0, 143);">id</span> <span class="s2" style="color: rgb(65, 161, 192);">obj</span> = objc_msgSend(NSMutableArray,<span class="s1" style="color: rgb(215, 0, 143);">@selector</span>(array));</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(65, 161, 192); background-color: rgb(31, 32, 41); white-space: normal;">objc_retainAutoreleasedReturnValue<span class="s3" style="color: rgb(225, 226, 231);">(obj);</span></p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(65, 161, 192); background-color: rgb(31, 32, 41); white-space: normal;">objc_release<span class="s3" style="color: rgb(225, 226, 231);">(obj);</span></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(65, 161, 192); background-color: rgb(31, 32, 41); white-space: normal;"><span class="s3" style="color: rgb(225, 226, 231);"><br/></span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;"></span><br/></p></blockquote><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">objc_retainAutoreleasedReturnValue函数主要用于优化程序的运行。它是用于持有(retain)对象的函数，它持有的对象应为返回注册在autoreleasePool中对象的方法，或是函数的返回值。像该源码这样，在调用array类方法之后，由编译器插入该函数。</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">而这种objc_retainAutoreleasedReturnValue函数是成对存在的，与之对应的函数是objc_autoreleaseReturnValue。它用于array类方法返回对象的实现上。下面看看NSMutableArray类的array方法通过编译器进行了怎样的转换：</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;"></span></p><p class="p1" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(65, 161, 192); background-color: rgb(31, 32, 41); white-space: normal;"><span class="s1" style="color: rgb(225, 226, 231);">+ (</span><span class="s2" style="color: rgb(215, 0, 143);">id</span><span class="s1" style="color: rgb(225, 226, 231);">)</span>array</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;">{</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p4" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(37, 144, 141); background-color: rgb(31, 32, 41); white-space: normal;"><span class="s2" style="color: rgb(215, 0, 143);">return</span><span class="s1" style="color: rgb(225, 226, 231);"> [[</span>NSMutableArray<span class="s1" style="color: rgb(225, 226, 231);"> </span>alloc<span class="s1" style="color: rgb(225, 226, 231);">] </span>init<span class="s1" style="color: rgb(225, 226, 231);">];</span></p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;">}</p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;"><br/></span><br/></p><blockquote style="border-width: 0px 0px 0px 4px; border-top-style: initial; border-right-style: initial; border-bottom-style: initial; border-left-style: solid; border-top-color: initial; border-right-color: initial; border-bottom-color: initial; border-left-color: rgb(204, 204, 204); border-image: initial; margin: 0px; padding: 0px 0px 0px 16px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;">//编译器模拟代码</span></p><p class="p1" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(65, 161, 192); background-color: rgb(31, 32, 41); white-space: normal;"><span class="s1" style="color: rgb(225, 226, 231);">+ (</span><span class="s2" style="color: rgb(215, 0, 143);">id</span><span class="s1" style="color: rgb(225, 226, 231);">)</span>array</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;">{</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;"><span class="s2" style="color: rgb(215, 0, 143);">id</span> obj = objc_msgSend(NSMutableArray,<span class="s2" style="color: rgb(215, 0, 143);">@selector</span>(alloc));</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;"><span class="s3" style="color: rgb(29, 169, 162);">objc_msgSend</span>(obj,<span class="s2" style="color: rgb(215, 0, 143);">@selector</span>(init));</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p4" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(69, 187, 62); background-color: rgb(31, 32, 41); white-space: normal;">// 代替我们调用了autorelease方法</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p5" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(29, 169, 162); background-color: rgb(31, 32, 41); white-space: normal;"><span class="s2" style="color: rgb(215, 0, 143);">return</span><span class="s1" style="color: rgb(225, 226, 231);"> </span>objc_autoreleaseReturnValue<span class="s1" style="color: rgb(225, 226, 231);">(obj);</span></p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;">}</p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><br/></p></blockquote><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">我们可以看见调用了objc_autoreleaseReturnValue函数且这个函数会返回注册到自动释放池的对象，但是，这个函数有个特点，它会查看调用方的命令执行列表，如果发现接下来会调用objc_retainAutoreleasedReturnValue则不会将返回的对象注册到autoreleasePool中而仅仅返回一个对象。达到了一种最优效果。如下图：</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: center;"><img src="/upload/image/20191117/213439795374.png" style="border: 0px; margin: 10px auto 0px; padding: 0px; display: block; max-width: 100%; height: auto;"/></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: center;"><span style="border: 0px; margin: 0px; padding: 0px;">省略了autoreleasePool注册</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px; font-size: 20px;"><span style="font-weight: 700; border: 0px; margin: 0px; padding: 0px;">__weak</span></span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">__weak 表示弱引用，对应定义 property 时用到的 weak。弱引用不会影响对象的释放，而当对象被释放时，所有指向它的弱引用都会自定被置为 nil，这样可以防止野指针。使用__weak修饰的变量，即是使用注册到autoreleasePool中的对象。__weak 最常见的一个作用就是用来避免循环循环。需要注意的是，__weak 修饰符只能用于 iOS5 以上的版本，在 iOS4 及更低的版本中使用 __unsafe_unretained 修饰符来代替。</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">__weak 的几个使用场景：</span></p><ul style="list-style-type: none;" class=" list-paddingleft-2"><li><p>在 Delegate 关系中防止循环引用。</p></li><li><p>在 Block 中防止循环引用。</p></li><li><p>用来修饰指向由 Interface Builder 创建的控件。比如：@property (weak, nonatomic) IBOutlet UIButton *testButton;。</p></li></ul><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px; font-size: 20px;"><span style="font-weight: 700; border: 0px; margin: 0px; padding: 0px;">原理</span></span></p><blockquote style="border-width: 0px 0px 0px 4px; border-top-style: initial; border-right-style: initial; border-bottom-style: initial; border-left-style: solid; border-top-color: initial; border-right-color: initial; border-bottom-color: initial; border-left-color: rgb(204, 204, 204); border-image: initial; margin: 0.63em 0px 0px; padding: 0px 0px 0px 16px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;">编译器转换后的代码如下:</span></blockquote><blockquote style="border-width: 0px 0px 0px 4px; border-top-style: initial; border-right-style: initial; border-bottom-style: initial; border-left-style: solid; border-top-color: initial; border-right-color: initial; border-bottom-color: initial; border-left-color: rgb(204, 204, 204); border-image: initial; margin: 0.63em 0px 0px; padding: 0px 0px 0px 16px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;"></span></p><p class="p1" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(65, 161, 192); background-color: rgb(31, 32, 41); white-space: normal;"><span class="s1" style="color: rgb(215, 0, 143);">id</span><span class="s2" style="color: rgb(225, 226, 231);"> </span>obj<span class="s2" style="color: rgb(225, 226, 231);">;</span></p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;"><span class="s1" style="color: rgb(215, 0, 143);">id</span> <span class="s3" style="color: rgb(65, 161, 192);">tmp</span> = objc_msgSend(NSObject,<span class="s1" style="color: rgb(215, 0, 143);">@selector</span>(alloc));</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;"><span class="s3" style="color: rgb(65, 161, 192);">objc_msgSend</span>(tmp,<span class="s1" style="color: rgb(215, 0, 143);">@selector</span>(init));</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p1" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(65, 161, 192); background-color: rgb(31, 32, 41); white-space: normal;">objc_initweak<span class="s2" style="color: rgb(225, 226, 231);">(&amp;obj,tmp);</span></p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p1" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(65, 161, 192); background-color: rgb(31, 32, 41); white-space: normal;">objc_release<span class="s2" style="color: rgb(225, 226, 231);">(tmp);</span></p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p1" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(65, 161, 192); background-color: rgb(31, 32, 41); white-space: normal;">objc_destroyWeak<span class="s2" style="color: rgb(225, 226, 231);">(&amp;object);</span></p><p class="p1" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(65, 161, 192); background-color: rgb(31, 32, 41); white-space: normal;"><span class="s2" style="color: rgb(225, 226, 231);"><br/></span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;"></span><br/></p></blockquote><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">对于__weak内存管理也借助了类似于引用计数表的散列表，它通过对象的内存地址做为key，而对应的__weak修饰符变量的地址作为value注册到weak表中，在上述代码中objc_initweak就是完成这部分操作，而objc_destroyWeak</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">则是销毁该对象对应的value。当指向的对象被销毁时，会通过其内存地址，去weak表中查找对应的__weak修饰符变量，将其从weak表中删除。所以，weak在修饰只是让weak表增加了记录没有引起引用计数表的变化.</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">对象通过objc_release释放对象内存的动作如下:</span></p><ol style="list-style-type: none;" class=" list-paddingleft-2"><li><p>objc_release</p></li><li><p>因为引用计数为0所以执行dealloc</p></li><li><p>_objc_rootDealloc</p></li><li><p>objc_dispose</p></li><li><p>objc_destructInstance</p></li><li><p>objc_clear_deallocating</p></li></ol><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">而在对象被废弃时最后调用了objc_clear_deallocating，该函数的动作如下:</span></p><ol style="list-style-type: none;" class=" list-paddingleft-2"><li><p>从weak表中获取已废弃对象内存地址对应的所有记录</p></li><li><p>将已废弃对象内存地址对应的记录中所有以weak修饰的变量都置为nil</p></li><li><p>从weak表删除已废弃对象内存地址对应的记录</p></li><li><p>根据已废弃对象内存地址从引用计数表中找到对应记录删除</p></li></ol><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">据此可以解释为什么对象被销毁时对应的weak指针变量全部都置为nil，同时，也看出来销毁weak步骤较多，如果大量使用weak的话会增加CPU的负荷。</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">还需要确认一点是：__weak修饰符的变量，即是使用注册到autoreleasePool中的对象。</span></p><blockquote style="border-width: 0px 0px 0px 4px; border-top-style: initial; border-right-style: initial; border-bottom-style: initial; border-left-style: solid; border-top-color: initial; border-right-color: initial; border-bottom-color: initial; border-left-color: rgb(204, 204, 204); border-image: initial; margin: 0.63em 0px 0px; padding: 0px 0px 0px 16px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;"></span></p><p class="p1" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;">{</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p1" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;"><span class="s1" style="color: rgb(215, 0, 143);">id</span> <span class="s1" style="color: rgb(215, 0, 143);">__weak</span> obj1 = obj;</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p1" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;">NSLog(<span class="s2" style="color: rgb(211, 35, 46);">@&quot;obj2-%@&quot;</span>,obj1);</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p1" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;">}</p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;"></span><br/></p></blockquote><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">编译器转换上述代码如下:</span></p><blockquote style="border-width: 0px 0px 0px 4px; border-top-style: initial; border-right-style: initial; border-bottom-style: initial; border-left-style: solid; border-top-color: initial; border-right-color: initial; border-bottom-color: initial; border-left-color: rgb(204, 204, 204); border-image: initial; margin: 0.63em 0px 0px; padding: 0px 0px 0px 16px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><p class="p1" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(65, 161, 192); background-color: rgb(31, 32, 41); white-space: normal;"><span class="s1" style="color: rgb(215, 0, 143);"><br/></span></p><p class="p1" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(65, 161, 192); background-color: rgb(31, 32, 41); white-space: normal;"><span class="s1" style="color: rgb(215, 0, 143);">id</span><span class="s2" style="color: rgb(225, 226, 231);"> </span>obj1<span class="s2" style="color: rgb(225, 226, 231);">;</span></p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p1" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(65, 161, 192); background-color: rgb(31, 32, 41); white-space: normal;">objc_initweak<span class="s2" style="color: rgb(225, 226, 231);">(&amp;obj1,obj);</span></p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(29, 169, 162); background-color: rgb(31, 32, 41); white-space: normal;"><span class="s1" style="color: rgb(215, 0, 143);">id</span><span class="s2" style="color: rgb(225, 226, 231);"> </span><span class="s3" style="color: rgb(65, 161, 192);">tmp</span><span class="s2" style="color: rgb(225, 226, 231);"> = </span>objc_loadWeakRetained<span class="s2" style="color: rgb(225, 226, 231);">(&amp;</span>obj1<span class="s2" style="color: rgb(225, 226, 231);">);</span></p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p1" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(65, 161, 192); background-color: rgb(31, 32, 41); white-space: normal;">objc_autorelease<span class="s2" style="color: rgb(225, 226, 231);">(tmp);</span></p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p4" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;"><span class="s3" style="color: rgb(65, 161, 192);">NSLog</span>(<span class="s4" style="color: rgb(211, 35, 46);">@&quot;%@&quot;</span>,tmp);</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p1" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(65, 161, 192); background-color: rgb(31, 32, 41); white-space: normal;">objc_destroyWeak<span class="s2" style="color: rgb(225, 226, 231);">(&amp;obj1);</span></p><p class="p1" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(65, 161, 192); background-color: rgb(31, 32, 41); white-space: normal;"><span class="s2" style="color: rgb(225, 226, 231);"><br/></span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><br/></p></blockquote><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">objc_loadWeakRetained函数获取附有__weak修饰符变量所引用的对象并retain, objc_autorelease函数将对象放入autoreleasePool中，据此当我们访问weak修饰指针指向的对象时，实际上是访问注册到自动释放池的对象。因此，如果大量使用weak的话，在我们去访问weak修饰的对象时，会有大量对象注册到自动释放池,这会影响程序的性能。</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">解决方案：要访问weak修饰的变量时，先将其赋给一个strong变量，然后进行访问</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">为什么访问weak修饰的对象就会访问注册到自动释放池的对象呢?</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">因为weak不会引起对象的引用计数器变化，因此，该对象在运行过程中很有可能会被释放。所以，需要将对象注册到自动释放池中并在autoreleasePool销毁时释放对象占用的内存。</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px; font-size: 20px;">__unsafe_unretained</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">ARC 是在 iOS5 引入的，而 __unsafe_unretained 这个修饰符主要是为了在ARC刚发布时兼容iOS4以及版本更低的系统，因为这些版本没有弱引用机制。这个修饰符在定义property时对应的是unsafe_unretained。__unsafe_unretained 修饰的指针纯粹只是指向对象，没有任何额外的操作，不会去持有对象使得对象的 retainCount +1。而在指向的对象被释放时依然原原本本地指向原来的对象地址，不会被自动置为 nil，所以成为了野指针，非常不安全。</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">__unsafe_unretained 的应用场景：</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">在 ARC 环境下但是要兼容 iOS4.x 的版本，用__unsafe_unretained 替代 __weak 解决强循环循环的问题。</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px; font-size: 20px;">__autoreleasing</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">将对象赋值给附有__autoreleasing修饰符的变量等同于MRC时调用对象的autorelease方法。</span></p><blockquote style="border-width: 0px 0px 0px 4px; border-top-style: initial; border-right-style: initial; border-bottom-style: initial; border-left-style: solid; border-top-color: initial; border-right-color: initial; border-bottom-color: initial; border-left-color: rgb(204, 204, 204); border-image: initial; margin: 0.63em 0px 0px; padding: 0px 0px 0px 16px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;">编译器转换上述代码如下:<br/></p></blockquote><blockquote style="border-width: 0px 0px 0px 4px; border-top-style: initial; border-right-style: initial; border-bottom-style: initial; border-left-style: solid; border-top-color: initial; border-right-color: initial; border-bottom-color: initial; border-left-color: rgb(204, 204, 204); border-image: initial; margin: 0.63em 0px 0px; padding: 0px 0px 0px 16px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;"></span></p><p class="p1" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(29, 169, 162); background-color: rgb(31, 32, 41); white-space: normal;"><span class="s1" style="color: rgb(225, 226, 231);">&nbsp;</span><span class="s2" style="color: rgb(215, 0, 143);">id</span><span class="s1" style="color: rgb(225, 226, 231);"> </span><span class="s3" style="color: rgb(65, 161, 192);">pool</span><span class="s1" style="color: rgb(225, 226, 231);"> = </span>objc_autoreleasePoolPush<span class="s1" style="color: rgb(225, 226, 231);">();</span></p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;"><span class="Apple-converted-space">&nbsp;</span><span class="s2" style="color: rgb(215, 0, 143);">id</span> <span class="s3" style="color: rgb(65, 161, 192);">obj</span> = objc_msgSend(NSObject,<span class="s2" style="color: rgb(215, 0, 143);">@selector</span>(alloc));</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;"><span class="Apple-converted-space">&nbsp;</span><span class="s3" style="color: rgb(65, 161, 192);">objc_msgSend</span>(obj,<span class="s2" style="color: rgb(215, 0, 143);">@selector</span>(init));</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p4" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(65, 161, 192); background-color: rgb(31, 32, 41); white-space: normal;"><span class="s1" style="color: rgb(225, 226, 231);">&nbsp;</span>objc_autorelease<span class="s1" style="color: rgb(225, 226, 231);">(obj);</span></p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p4" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(65, 161, 192); background-color: rgb(31, 32, 41); white-space: normal;"><span class="s1" style="color: rgb(225, 226, 231);">&nbsp;</span>objc_autoreleasePoolPop<span class="s1" style="color: rgb(225, 226, 231);">(pool);</span></p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p5" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(215, 0, 143); background-color: rgb(31, 32, 41); white-space: normal;"><span class="s1" style="color: rgb(225, 226, 231);">&nbsp;</span>@autoreleasepool<span class="s1" style="color: rgb(225, 226, 231);"> {</span></p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;"><span class="Apple-converted-space">&nbsp;</span><span class="s2" style="color: rgb(215, 0, 143);">id</span> <span class="s2" style="color: rgb(215, 0, 143);">__autoreleasing</span> obj = [NSMutableArray array];</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;"><span class="Apple-converted-space">&nbsp;</span>}</p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;"></span><br/></p></blockquote><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">编译器转换上述代码如下:</span></p><blockquote style="border-width: 0px 0px 0px 4px; border-top-style: initial; border-right-style: initial; border-bottom-style: initial; border-left-style: solid; border-top-color: initial; border-right-color: initial; border-bottom-color: initial; border-left-color: rgb(204, 204, 204); border-image: initial; margin: 0.63em 0px 0px; padding: 0px 0px 0px 16px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;"></span></p><p class="p1" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(29, 169, 162); background-color: rgb(31, 32, 41); white-space: normal;"><span class="s1" style="color: rgb(215, 0, 143);"><br/></span></p><p class="p1" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(29, 169, 162); background-color: rgb(31, 32, 41); white-space: normal;"><span class="s1" style="color: rgb(215, 0, 143);">id</span><span class="s2" style="color: rgb(225, 226, 231);"> </span><span class="s3" style="color: rgb(65, 161, 192);">pool</span><span class="s2" style="color: rgb(225, 226, 231);"> = </span>objc_autoreleasePoolPush<span class="s2" style="color: rgb(225, 226, 231);">();</span></p><p class="p1" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(29, 169, 162); background-color: rgb(31, 32, 41); white-space: normal;"><span class="s2" style="color: rgb(225, 226, 231);"><br/></span></p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;"><span class="s1" style="color: rgb(215, 0, 143);">id</span> <span class="s3" style="color: rgb(65, 161, 192);">obj</span> = objc_msgSend(NSMutableArray,<span class="s1" style="color: rgb(215, 0, 143);">@selector</span>(array));</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p4" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(65, 161, 192); background-color: rgb(31, 32, 41); white-space: normal;">objc_retainAutoreleasedReturnValue<span class="s2" style="color: rgb(225, 226, 231);">(obj);</span></p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p4" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(65, 161, 192); background-color: rgb(31, 32, 41); white-space: normal;">objc_autorelease<span class="s2" style="color: rgb(225, 226, 231);">(obk);</span></p><p class="p4" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(65, 161, 192); background-color: rgb(31, 32, 41); white-space: normal;"><span class="s2" style="color: rgb(225, 226, 231);"><br/></span></p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p4" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(65, 161, 192); background-color: rgb(31, 32, 41); white-space: normal;">objc_autoreleasePoolPop<span class="s2" style="color: rgb(225, 226, 231);">(pool);</span></p><p class="p4" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(65, 161, 192); background-color: rgb(31, 32, 41); white-space: normal;"><span class="s2" style="color: rgb(225, 226, 231);"><br/></span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;"></span><br/></p></blockquote><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">上面两种方式，虽然第二种持有对象的方法从alloc方法变为了objc_retainAutoreleasedReturnValue函数，都是通过objc_autorelease，注册到autoreleasePool中。</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="font-weight: 700; border: 0px; margin: 0px; padding: 0px;"><span style="border: 0px; margin: 0px; padding: 0px; font-size: 20px;">ARC 模式规则</span></span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">ARC 模式下，还有一些需要注意的规则：</span></p><ul style="list-style-type: none;" class=" list-paddingleft-2"><li><p>不能显式使用 retain/release/retainCount/autorelease。</p></li><li><p>不能使用 NSAllocateObject/NSDeallocateObject。</p></li><li><p>需要遵守内存管理的方法命名规则。在 ARC 模式和 MRC 模式下，以 alloc/new/copy/mutableCopy 开头的方法在返回对象时都必须返回给调用方所应当持有的对象。在 ARC 模式下，追加一条：以 init 开头的方法必须是实例方法并且必须要返回对象。返回的对象应为 id 类型或声明该方法的类的对象类型，或是该类的超类型或子类型。该返回的对象并不注册到 Autorelease Pool 中，基本上只是对 alloc 方法返回值的对象进行初始化处理并返回该对象。需要注意的是：- (void)initialize; 方法虽然是以 init 开头但是并不包含在上述规则中。</p></li><li><p>不要显式调用 dealloc。</p></li><li><p>使用 @autoreleasepool 块替代 NSAutoreleasePool。</p></li><li><p>不能使用区域（NSZone）。</p></li><li><p>对象型变量不能作为 C 语言结构体（struct/union）的成员。</p></li><li><p>显式转换 id 和 void *。</p></li></ul><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px; font-size: 20px;"><span style="font-weight: 700; border: 0px; margin: 0px; padding: 0px;">Toll-Free Bridging</span></span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">MRC 下的 Toll－Free Bridging 因为不涉及内存管理的转移，相互之间可以直接交换使用，当使用 ARC 时，由于Core Foundation 框架并不支持 ARC，此时编译器不知道该如何处理这个同时有 ObjC 指针和 CFTypeRef 指向的对象，所以除了转换类型，还需指定内存管理所有权的改变，可通过 __bridge、__bridge_retained 和 CFBridgingRetain、__bridge_transfer 和 CFBridgingRelease。</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px; font-size: 20px;"><span style="font-weight: 700; border: 0px; margin: 0px; padding: 0px;">__bridge</span></span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">只是声明类型转变，但是不做内存管理规则的转变。比如：</span></p><blockquote style="border-width: 0px 0px 0px 4px; border-top-style: initial; border-right-style: initial; border-bottom-style: initial; border-left-style: solid; border-top-color: initial; border-right-color: initial; border-bottom-color: initial; border-left-color: rgb(204, 204, 204); border-image: initial; margin: 0.63em 0px 0px; padding: 0px 0px 0px 16px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;">CFStringRef s1 = (__bridge CFStringRef) [[NSString alloc] initWithFormat:@&quot;Hello, %@!&quot;, name];</span></p></blockquote><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">只是做了 NSString 到 CFStringRef 的转化，但管理规则未变，依然要用 Objective-C 类型的 ARC 来管理 s1，你不能用 CFRelease() 去释放 s1。</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px; font-size: 20px;"><span style="font-weight: 700; border: 0px; margin: 0px; padding: 0px;">__bridge_retained or CFBridgingRetain</span></span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">表示将指针类型转变的同时，将内存管理的责任由原来的 Objective-C 交给Core Foundation 来处理，也就是，将 ARC 转变为 MRC。比如，还是上面那个例子</span></p><blockquote style="border-width: 0px 0px 0px 4px; border-top-style: initial; border-right-style: initial; border-bottom-style: initial; border-left-style: solid; border-top-color: initial; border-right-color: initial; border-bottom-color: initial; border-left-color: rgb(204, 204, 204); border-image: initial; margin: 0.63em 0px 0px; padding: 0px 0px 0px 16px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;"></span></p><p class="p1" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;"><span class="s1" style="color: rgb(37, 144, 141);">NSString</span> *<span class="s2" style="color: rgb(65, 161, 192);">s1</span> = [[NSString alloc] initWithFormat:<span class="s3" style="color: rgb(211, 35, 46);">@&quot;Hello, %@!&quot;</span>, name];</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p1" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;"><span class="s1" style="color: rgb(37, 144, 141);">CFStringRef</span> <span class="s2" style="color: rgb(65, 161, 192);">s2</span> = (<span class="s4" style="color: rgb(215, 0, 143);">__bridge_retained</span> CFStringRef)s1;</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(69, 187, 62); background-color: rgb(31, 32, 41); white-space: normal;">// or CFStringRef s2 = (CFStringRef)CFBridgingRetain(s1);</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(69, 187, 62); background-color: rgb(31, 32, 41); white-space: normal;">// do something with s2</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(69, 187, 62); background-color: rgb(31, 32, 41); white-space: normal;">//...</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(69, 187, 62); background-color: rgb(31, 32, 41); white-space: normal;"><span class="s2" style="color: rgb(65, 161, 192);">CFRelease</span><span class="s5" style="color: rgb(225, 226, 231);">(s2); </span>// 注意要在使用结束后加这个</p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><span style="border: 0px; margin: 0px; padding: 0px;"></span><br/></p></blockquote><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">我们在第二行做了转化，这时内存管理规则由 ARC 变为了 MRC，我们需要手动的来管理 s2 的内存，而对于 s1，我们即使将其置为 nil，也不能释放内存。</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px; font-size: 20px;"><span style="font-weight: 700; border: 0px; margin: 0px; padding: 0px;">__bridge_transfer or CFBridgingRelease</span></span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">这个修饰符和函数的功能和上面那个 __bridge_retained 相反，它表示将管理的责任由 Core Foundation 转交给 Objective-C，即将管理方式由 MRC 转变为 ARC。比如：</span></p><blockquote style="border-width: 0px 0px 0px 4px; border-top-style: initial; border-right-style: initial; border-bottom-style: initial; border-left-style: solid; border-top-color: initial; border-right-color: initial; border-bottom-color: initial; border-left-color: rgb(204, 204, 204); border-image: initial; margin: 0.63em 0px 0px; padding: 0px 0px 0px 16px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0;"><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;"></span></p><p class="p1" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;"><span class="s1" style="color: rgb(37, 144, 141);">CFStringRef</span> <span class="s2" style="color: rgb(65, 161, 192);">result</span> = CFURLCreateStringByAddingPercentEscapes(. . .);</p><p class="p1" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); white-space: normal;"><br/></p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(215, 0, 143); background-color: rgb(31, 32, 41); white-space: normal;"><span class="s1" style="color: rgb(37, 144, 141);">NSString</span><span class="s3" style="color: rgb(225, 226, 231);"> *</span><span class="s2" style="color: rgb(65, 161, 192);">s</span><span class="s3" style="color: rgb(225, 226, 231);"> = (</span>__bridge_transfer<span class="s3" style="color: rgb(225, 226, 231);"> </span><span class="s1" style="color: rgb(37, 144, 141);">NSString</span><span class="s3" style="color: rgb(225, 226, 231);"> *)</span><span class="s4" style="color: rgb(29, 169, 162);">result</span><span class="s3" style="color: rgb(225, 226, 231);">;</span></p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p4" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(69, 187, 62); background-color: rgb(31, 32, 41); white-space: normal;">//or NSString *s = (NSString *)CFBridgingRelease(result);</p><p class="p2" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(225, 226, 231); background-color: rgb(31, 32, 41); min-height: 14px; white-space: normal;"><br/></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(215, 0, 143); background-color: rgb(31, 32, 41); white-space: normal;">return<span class="s3" style="color: rgb(225, 226, 231);"> </span><span class="s2" style="color: rgb(65, 161, 192);">s</span><span class="s3" style="color: rgb(225, 226, 231);">;</span></p><p class="p3" style="margin-top: 0px; margin-bottom: 0px; font-variant-numeric: normal; font-variant-east-asian: normal; font-stretch: normal; font-size: 12px; line-height: normal; font-family: Menlo; color: rgb(215, 0, 143); background-color: rgb(31, 32, 41); white-space: normal;"><span class="s3" style="color: rgb(225, 226, 231);"><br/></span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;"></span><br/></p></blockquote><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">这里我们将 result 的管理责任交给了 ARC 来处理，我们就不需要再显式地将 CFRelease() 了。</span></p><p style="border: 0px; margin-top: 0.63em; margin-bottom: 1.8em; padding: 0px; counter-reset: list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; text-align: justify;"><span style="border: 0px; margin: 0px; padding: 0px;">原文链接:<a href="http://www.sohu.com/a/227519309_208051">http://www.sohu.com/a/227519309_208051</a></span></p></article><p><br/></p>
             </div>
         </div>
        <div class="row" style="background-color: #eeeeee;">
            
             <div class="col-sm-4 text-left left-arror">
                 
             </div>
       
             <div class="col-sm-4 col-sm-offset-4 text-right right-arror">
                
             </div>
        
         </div>

    </div>
</div>
<div class="row">
    <div class="col-sm-12 text-center" style="padding-top: 10px;">
        <a href="https://www.onlinegdb.com/" target="_blank"><strong><font color="black">在线编程工具</font></strong></a>
    </div>
</div>
</div>
<script type="text/javascript">
// var siteHome = './';
var tutorial_id = 'a948A25C';
var article_id = 'a24C78b3';
</script>

	
	<a href="https://beian.miit.gov.cn"><div style="text-align: center; height: 60px;padding-top: 20px;">鄂ICP备20003145号-1</div></a>	
	
</body>